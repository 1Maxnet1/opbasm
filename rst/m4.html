<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>m4 support in Opbasm &mdash; Opbasm 1.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/project.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Kreon:400,300,700' rel='stylesheet' type='text/css'>

   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../index.html" title="Open PicoBlaze Assembler"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Opbasm 1.3 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="m4-support-in-opbasm">
<h1>m4 support in Opbasm<a class="headerlink" href="#m4-support-in-opbasm" title="Permalink to this headline">Â¶</a></h1>
<p>The m4 preprocessor adds powerful facilities for enhanced PicoBlaze assembly. m4 is typically already present on most Linux systems. Various implementations can be installed on Windows. Opbasm will automatically run m4 if a source file has the extension &#8221;.psm4&#8221; or &#8221;.m4&#8221; or on any file if the <tt class="docutils literal"><span class="pre">--m4</span></tt> option is used. The included macro package depends on some GNU extensions so GNU m4 must be used if the built-in macros are employed.</p>
<p>Predefined macros are provided with Opbasm covering the following areas:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#stack-operations">Stack operations</a></li>
<li><a class="reference internal" href="#bitfield-manipulations">Bitfield manipulations</a></li>
<li><a class="reference internal" href="#shift-and-rotate-by-multiple-bits">Shift and rotate by multiple bits</a></li>
<li><a class="reference internal" href="#conditional-jump-call-and-return">Conditional jump, call, and return</a></li>
<li><a class="reference internal" href="#conditional-if-then-else">Conditional if-then-else</a></li>
<li><a class="reference internal" href="#looping">Looping</a></li>
<li><a class="reference internal" href="#delay-generators">Delay generators</a></li>
<li><a class="reference internal" href="#portable-string-and-table-operations">Portable string and table operations</a></li>
<li><a class="reference internal" href="#bit-arithmetic-logical-and-shift-operators">16-bit arithmetic, logical, and shift operators</a></li>
<li><a class="reference internal" href="#bit-i-o-operations">16-bit I/O operations</a></li>
<li><a class="reference internal" href="#multiply-and-divide-routines">Multiply and divide routines</a></li>
<li><a class="reference internal" href="#expressions">Expressions</a></li>
</ul>
</div></blockquote>
<p>Using these macros you can write code in a higher-level style like the following Fibonacci generator.</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">With macros:</th>
<th class="head">After expansion:</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last highlight-picoblaze"><div class="highlight"><pre><span class="nl">fibonacci:</span>
  <span class="c">; Generate the first 10 Fibonacci numbers</span>
  <span class="nb">vars(</span><span class="s">s0</span> <span class="s">is</span> <span class="s">counter</span><span class="p">,</span> <span class="s">s1</span> <span class="s">is</span> <span class="s">two_prev</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span>
      <span class="s">s2</span> <span class="s">is</span> <span class="s">prev</span> <span class="o">:=</span> <span class="m">1</span><span class="p">,</span> <span class="s">s3</span> <span class="s">is</span> <span class="s">next</span><span class="nb">)</span>
  <span class="nb">for (</span><span class="s">counter</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="s">counter</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">,</span> <span class="s">counter</span> <span class="o">:=</span> <span class="s">counter</span> <span class="o">+</span> <span class="m">1</span><span class="nb">)</span> <span class="p">{</span>
   <span class="nb">if (</span><span class="s">counter</span> <span class="o">&lt;</span> <span class="m">2</span><span class="nb">)</span> <span class="p">{</span>
     <span class="k">LOAD</span> <span class="n">next</span><span class="p">,</span> <span class="n">counter</span>
   <span class="p">}</span> <span class="nb">else</span> <span class="p">{</span>
     <span class="c">; Compute next number</span>
     <span class="nb">expr(</span><span class="s">next</span> <span class="o">:=</span> <span class="s">two_prev</span> <span class="o">+</span> <span class="s">prev</span><span class="nb">)</span>
     <span class="k">LOAD</span> <span class="n">two_prev</span><span class="p">,</span> <span class="n">prev</span>
     <span class="k">LOAD</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span>
   <span class="p">}</span>
   <span class="nb">push(</span><span class="s">next</span><span class="nb">)</span>
   <span class="k">CALL</span> <span class="n">print_num</span>   <span class="c">; Output the next number</span>
  <span class="p">}</span>
  <span class="k">RETURN</span>
</pre></div>
</div>
</td>
<td><div class="first last highlight-picoblaze"><div class="highlight"><pre>      <span class="nl">fibonacci:</span>
                 <span class="c">; Generate the first 10 Fibonacci numbers</span>
                 <span class="k">LOAD</span> <span class="n">s1</span><span class="p">,</span> <span class="mh">00</span>          <span class="c">; Var two_prev := 0</span>
                 <span class="k">LOAD</span> <span class="n">s2</span><span class="p">,</span> <span class="mh">01</span>          <span class="c">; Var prev := 1</span>
                 <span class="c">; Expression: s0 := 0</span>
                 <span class="k">LOAD</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>

    <span class="nl">FOR_f1_0001:</span>
                 <span class="c">; If s0 &lt; 10</span>
                 <span class="k">COMPARE</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">0a</span>
                 <span class="k">JUMP</span> <span class="n">nc</span><span class="p">,</span> <span class="n">GE_f1_0004</span>

                 <span class="c">; If s0 &lt; 2</span>
                 <span class="k">COMPARE</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">02</span>
                 <span class="k">JUMP</span> <span class="n">nc</span><span class="p">,</span> <span class="n">GE_f1_0006</span>
                 <span class="k">LOAD</span> <span class="n">s3</span><span class="p">,</span> <span class="n">s0</span>
                 <span class="k">JUMP</span> <span class="n">ENDIF_f1_0007</span>

     <span class="nl">GE_f1_0006:</span>
                 <span class="c">; Compute next number</span>
                 <span class="c">; Expression: s3 := s1 + s2</span>
                 <span class="k">LOAD</span> <span class="n">s3</span><span class="p">,</span> <span class="n">s1</span>
                 <span class="k">ADD</span> <span class="n">s3</span><span class="p">,</span> <span class="n">s2</span>
                 <span class="k">LOAD</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span>
                 <span class="k">LOAD</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span>

  <span class="nl">ENDIF_f1_0007:</span>
                 <span class="k">STORE</span> <span class="n">s3</span><span class="p">,</span> <span class="p">(</span><span class="n">sf</span><span class="p">)</span>       <span class="c">; Push</span>
                 <span class="k">SUB</span> <span class="n">sf</span><span class="p">,</span> <span class="mh">01</span>
                 <span class="k">CALL</span> <span class="n">print_num</span>       <span class="c">; Output the next number</span>

<span class="nl">NEXTFOR_f1_0002:</span>
                 <span class="c">; Expression: s0 := s0 + 1</span>
                 <span class="k">ADD</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">01</span>
                 <span class="k">JUMP</span> <span class="n">FOR_f1_0001</span>
     <span class="nl">GE_f1_0004:</span>
<span class="nl">ENDLOOP_f1_0003:</span>
                 <span class="k">RETURN</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="installing-m4-on-windows">
<span id="guidance-on-installing-m4-under-windows"></span><h2>Installing m4 on Windows<a class="headerlink" href="#installing-m4-on-windows" title="Permalink to this headline">Â¶</a></h2>
<p>There are a few options for installing m4 on Windows: MinGW, GnuWin32, and Cygwin.</p>
<div class="section" id="mingw">
<h3>MinGW<a class="headerlink" href="#mingw" title="Permalink to this headline">Â¶</a></h3>
<p>Download the <a class="reference external" href="http://sourceforge.net/projects/mingw/files/Installer/">get-mingw-setup</a> graphical installer. Run it and select the &#8220;msys-base&#8221; package and either &#8220;msys-m4&#8221; binary package (under All packages|MSYS|MSYS Base System) or &#8220;mingw-developer-toolkit&#8221;. Add &#8220;C:\MinGW\msys\1.0\bin&#8221; to your system PATH environment variable.</p>
</div>
<div class="section" id="gnuwin32">
<h3>GnuWin32<a class="headerlink" href="#gnuwin32" title="Permalink to this headline">Â¶</a></h3>
<p>To install the GnuWin32 version of m4, download the <a class="reference external" href="http://gnuwin32.sourceforge.net/packages/m4.htm">m4</a> and <a class="reference external" href="http://gnuwin32.sourceforge.net/packages/regex.htm">regex</a> packages. Unzip them and put regex2.dll into the same directory as m4.exe. Add the installation directory to your system PATH environment variable.</p>
</div>
<div class="section" id="cygwin">
<h3>Cygwin<a class="headerlink" href="#cygwin" title="Permalink to this headline">Â¶</a></h3>
<p>This option is best if you&#8217;ve installed Opbasm into a Cygwin environment. In the <a class="reference external" href="http://cygwin.com/install.html">Cygwin installer</a> select the m4 package (under Interpreters) for installation. Opbasm will be able to use m4 immediately within a Cygwin shell.</p>
</div>
</div>
<div class="section" id="overview-of-m4">
<h2>Overview of m4<a class="headerlink" href="#overview-of-m4" title="Permalink to this headline">Â¶</a></h2>
<p>m4 performs text based string manipulation by performing expansion of previously defined macros. The preprocessor has a number of built in macros and provides a means to define your own. Macros have a name that contains letters, digits, and underscores. Any arguments are enclosed in parentheses and delimited by commas. Expansion is suppressed by enclosing text in quote characters which are <tt class="docutils literal"><span class="pre">`'</span></tt> by default. Comments start with &#8220;#&#8221; by default but have been changed to use &#8221;;&#8221; to match PicoBlaze syntax.</p>
<p>m4 uses different syntax from PicoBlaze assembly to represent different types of literals. It is important to know what context you are operating in to determine which type of literal to put in your source.</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="35%" />
<col width="32%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Type</strong></th>
<th class="head"><strong>PicoBlaze</strong></th>
<th class="head"><strong>m4</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>decimal</td>
<td>10&#8217;d</td>
<td>10</td>
</tr>
<tr class="row-odd"><td>hexadecimal</td>
<td>0a</td>
<td>0x0a</td>
</tr>
<tr class="row-even"><td>binary</td>
<td>00001010&#8217;b</td>
<td>0b1010</td>
</tr>
<tr class="row-odd"><td>char</td>
<td>&#8220;A&#8221;</td>
<td>A or <tt class="docutils literal"><span class="pre">`A'</span></tt></td>
</tr>
</tbody>
</table>
<p>In general you use m4 syntax for literals passed as arguments to macros within parentheses. The only exception is <tt class="docutils literal"><span class="pre">pbhex()</span></tt> which takes a list of hex values in PicoBlaze format. Be careful not to use PicoBlaze hex format in other m4 contexts as it will be misinterpreted as decimal if only digits 0-9 are used.</p>
<p>m4 includes the ability to evaluate arbitrary integer expressions using the <tt class="docutils literal"><span class="pre">eval()</span></tt> macro. Its default output is an m4 decimal integer so the similar <tt class="docutils literal"><span class="pre">evalh()</span></tt> and <tt class="docutils literal"><span class="pre">evald()</span></tt> are provided to evaluate expressions resulting in PicoBlaze hex or decimal format.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="nb">evald(</span><span class="m">4</span> <span class="o">*</span> <span class="m">5</span> <span class="o">+</span> <span class="m">1</span><span class="nb">)</span>     <span class="c">; Expands to &quot;load s0, 21&#39;d&quot;</span>
</pre></div>
</div>
<p>The expression evaluator permits the natural use of negative decimal literals:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="nb">evalh(</span><span class="o">-</span><span class="m">20</span><span class="nb">)</span>           <span class="c">; Expands to &quot;load s0, ec&quot;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">evala()</span></tt> macro works like <tt class="docutils literal"><span class="pre">evalh()</span></tt> but expands to a 12-bit PicoBlaze address.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">define(</span><span class="s">DATA_ORG</span><span class="p">,</span> <span class="mh">0x200</span><span class="nb">)</span>
<span class="k">address</span> <span class="nb">evala(</span><span class="s">DATA_ORG</span><span class="nb">)</span>       <span class="c">; Expands to &quot;address 200&quot;</span>
</pre></div>
</div>
<p>m4 expressions support all of the C language operators as well as <tt class="docutils literal"><span class="pre">**</span></tt> for exponentiation.</p>
<p>An <tt class="docutils literal"><span class="pre">evalx()</span></tt> macro is available which works like the builtin <tt class="docutils literal"><span class="pre">eval()</span></tt> but also accepts strings that are not valid expressions.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="nb">evalx(</span><span class="m">9</span> <span class="o">+</span> <span class="m">2</span><span class="p">,</span> <span class="m">16</span><span class="p">,</span> <span class="m">2</span><span class="nb">)</span>  <span class="c">; Expands to &quot;load s0, 0b&quot;</span>
<span class="k">constant</span> <span class="n">CNAME</span><span class="p">,</span> <span class="mh">1f</span>
<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="nb">evalx(</span><span class="s">CNAME</span><span class="nb">)</span>         <span class="c">; Expands to &quot;load s0, CNAME&quot;</span>
</pre></div>
</div>
<p>You can define aliases for registers without altering the original as with NAMEREG.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">define(</span><span class="s">alt_name</span><span class="p">,</span> <span class="s">s0</span><span class="nb">)</span>
<span class="k">load</span> <span class="n">alt_name</span><span class="p">,</span> <span class="mh">01</span>             <span class="c">; Expands to &quot;load s0, 01&quot;</span>
<span class="k">add</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">01</span>                    <span class="c">; s0 register is still visible</span>
</pre></div>
</div>
<p>Special logic is implemented in a preprocessor stage so that PicoBlaze constants are visible to m4. They are automatically converted from PicoBlaze format into m4 format.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">constant</span> <span class="n">THE_ANSWER</span><span class="p">,</span> <span class="m">42&#39;d</span>
<span class="nb">expr(</span><span class="s">s0</span> <span class="o">:=</span> <span class="s">s1</span> <span class="o">+</span> <span class="s">THE_ANSWER</span><span class="nb">)</span>                            <span class="c">; Same as expr(s0 := s1 + 42)</span>
<span class="nb">if(</span><span class="s">s0</span> <span class="o">&gt;</span> <span class="s">THE_ANSWER</span><span class="p">,</span> <span class="s">`output</span> <span class="s">s1</span><span class="p">,</span> <span class="m">00</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">`output</span> <span class="s">s2</span><span class="p">,</span> <span class="m">00</span><span class="s">&#39;</span><span class="nb">)</span>  <span class="c">; Left operand is treated like a constant</span>
</pre></div>
</div>
<p>You can use also use <tt class="docutils literal"><span class="pre">define()</span></tt> to establish constants that are visible to m4 and create more complex macros. <a class="reference external" href="http://mbreen.com/m4.html">Michael Breen&#8217;s notes on m4</a> provide a good introductory overview to m4. The <a class="reference external" href="https://www.gnu.org/savannah-checkouts/gnu/m4/manual/">Gnu m4 manual</a> provides more detailed documentation.</p>
</div>
<div class="section" id="type-conversions">
<h2>Type conversions<a class="headerlink" href="#type-conversions" title="Permalink to this headline">Â¶</a></h2>
<p>Some basic macros are provided to perform type conversions. They are useful for constructing parameters to other macros that only expect decimal values.</p>
<p>The <tt class="docutils literal"><span class="pre">pbhex()</span></tt> macro is used to convert a list of values in PicoBlaze hex format into m4 decimals.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">pbhex(</span><span class="mh">0a</span><span class="p">,</span> <span class="mh">0b</span><span class="p">,</span> <span class="mh">ff</span><span class="nb">)</span>         <span class="c">; Expands to &quot;10, 11, 255&quot;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">asciiord()</span></tt> macro converts a string of one or more characters to a list of decimals representing their ASCII encoding. Quotes are not strictly necessary but guard against including trailing whitespace.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">asciiord(</span><span class="m">0</span><span class="nb">)</span>               <span class="c">; Expands to &quot;48&quot;</span>
<span class="nb">asciiord(</span><span class="s">`any</span> <span class="s">str&#39;</span><span class="nb">)</span>       <span class="c">; Expands to &quot;97, 110, 121, 32, 115, 116, 114&quot;</span>
</pre></div>
</div>
<p>If you need a NUL terminated string the <tt class="docutils literal"><span class="pre">asciiord_cstr()</span></tt> macro works the same but appends a terminating 0:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">asciiord_cstr(</span><span class="s">`1234&#39;</span><span class="nb">)</span>     <span class="c">; Expands to &quot;49, 50, 51, 52, 0&quot;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">words_le()</span></tt> and <tt class="docutils literal"><span class="pre">words_be()</span></tt> macros convert a list of 16-bit numbers into little-endian or big-endian bytes.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">words_le(</span><span class="mh">0xff01</span><span class="p">,</span> <span class="mh">0xff02</span><span class="nb">)</span>  <span class="c">; Expands to &quot;1, 255, 2, 255&quot;</span>
<span class="nb">words_be(</span><span class="mh">0xff01</span><span class="p">,</span> <span class="mh">0xff02</span><span class="nb">)</span>  <span class="c">; Expands to &quot;255, 1, 255, 2&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="general-purpose-macros">
<h2>General purpose macros<a class="headerlink" href="#general-purpose-macros" title="Permalink to this headline">Â¶</a></h2>
<p>A few of the macros depend on modifying a temporary register. To simplify the macro calls, the temp register is set to <cite>sE</cite> by default. You can change it to another register by calling <tt class="docutils literal"><span class="pre">use_tempreg(&lt;reg&gt;)</span></tt>. The temp register can be accessed in your own macros by using the <tt class="docutils literal"><span class="pre">&quot;_tempreg&quot;</span></tt> macro.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">use_tempreg(</span><span class="s">sA</span><span class="nb">)</span>    <span class="c">; Switch to sA for the temp register</span>
</pre></div>
</div>
<p>The following macros use the temp register:</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="18%" />
<col width="20%" />
<col width="22%" />
<col width="24%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>setcy</td>
<td>expr2s</td>
<td>multiply8x8</td>
<td>multiply8x8s</td>
<td>multiply8x8su</td>
</tr>
<tr class="row-even"><td>divide8x8</td>
<td>divide8x8s</td>
<td>divide16x8</td>
<td>divide16x8s</td>
<td>divide8xk</td>
</tr>
</tbody>
</table>
<p>The other <tt class="docutils literal"><span class="pre">expr()</span></tt> macros use the temp register indirectly when the mul and div operations are invoked.</p>
<p>PicoBlaze programs commonly contain lists of constant declarations for IO port addresses. The <tt class="docutils literal"><span class="pre">iodefs(&lt;start</span> <span class="pre">port&gt;,</span> <span class="pre">[port</span> <span class="pre">names]+)</span></tt> macro simplifies their declaration by allowing contiguous sequences of ports to be named in one statement. It can also be used to define scratchpad addresses.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">iodefs(</span><span class="m">0</span><span class="p">,</span> <span class="s">P_control</span><span class="p">,</span> <span class="s">P_read</span><span class="p">,</span> <span class="s">P_write</span><span class="nb">)</span>

<span class="c">; Expands to:</span>
  <span class="k">constant</span> <span class="n">P_control</span><span class="p">,</span> <span class="mh">00</span>
  <span class="k">constant</span> <span class="n">P_read</span><span class="p">,</span> <span class="mh">01</span>
  <span class="k">constant</span> <span class="n">P_write</span><span class="p">,</span> <span class="mh">02</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">vars([&lt;reg&gt;</span> <span class="pre">is</span> <span class="pre">&lt;alias&gt;</span> <span class="pre">[:=</span> <span class="pre">&lt;init&gt;]]+)</span></tt> macro allows you to associate alias names with a register. Unlike the <tt class="docutils literal"><span class="pre">NAMEREG</span></tt> directive, the original register name is still available. An optional initial value can be provided:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">vars(</span><span class="s">s0</span> <span class="s">is</span> <span class="s">count</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="s">s1</span> <span class="s">is</span> <span class="s">sum</span><span class="nb">)</span>

<span class="c">; Expands to:</span>
  <span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>
</pre></div>
</div>
<p>Symbols &#8220;count&#8221; and &#8220;sum&#8221; can now be used in place of s0 and s1.</p>
</div>
<div class="section" id="stack-operations">
<h2>Stack operations<a class="headerlink" href="#stack-operations" title="Permalink to this headline">Â¶</a></h2>
<p>A set of macros are available to simulate a stack using the scratchpad RAM. You initialize the stack and establish the stack pointer register with a call to <tt class="docutils literal"><span class="pre">use_stack()</span></tt>. After that you can call <tt class="docutils literal"><span class="pre">push()</span></tt> and <tt class="docutils literal"><span class="pre">pop()</span></tt> to manage registers on the stack. You can push and pop any number of registers at once. Pops happen in reverse order to preserve register values when passed the same list as <tt class="docutils literal"><span class="pre">push()</span></tt>. The stack grows down so the initial address should be the highest the stack will occupy.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">namereg</span> <span class="n">sF</span><span class="p">,</span> <span class="n">SP</span>      <span class="c">; Protect sF for use as the stack pointer</span>
<span class="nb">use_stack(</span><span class="s">SP</span><span class="p">,</span> <span class="mh">0x3F</span><span class="nb">)</span> <span class="c">; Start stack at end of 64-byte scratchpad</span>
...

<span class="nl">my_func:</span>
  <span class="nb">push(</span><span class="s">s0</span><span class="p">,</span> <span class="s">s1</span><span class="nb">)</span>
  <span class="ge">&lt;Do something that alters s0 and s1&gt;</span>
  <span class="nb">pop(</span><span class="s">s0</span><span class="p">,</span> <span class="s">s1</span><span class="nb">)</span>
  <span class="k">return</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">getstack()</span></tt>, <tt class="docutils literal"><span class="pre">getstackat()</span></tt>, and <tt class="docutils literal"><span class="pre">dropstack()</span></tt> macros can be used to retrieve and drop values from a stack frame. This provides a facility for passing function arguments on the stack and is particularly useful for writing functions that take a variable number of arguments. Use the <tt class="docutils literal"><span class="pre">dropstackreg()</span></tt> macro to drop a variable number of arguments stored in a register.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre>  <span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">BE</span>
  <span class="nb">push(</span><span class="s">s0</span><span class="nb">)</span>    <span class="c">; First argument</span>
  <span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">EF</span>
  <span class="nb">push(</span><span class="s">s0</span><span class="nb">)</span>    <span class="c">; Second argument</span>
  <span class="k">call</span> <span class="n">my_func2</span>

<span class="nl">my_func2:</span>
  <span class="nb">getstack(</span><span class="s">s3</span><span class="p">,</span> <span class="s">s4</span><span class="nb">)</span>     <span class="c">; Retrieve first and second argument</span>
  <span class="ge">&lt;Do your business&gt;</span>
  <span class="nb">dropstack(</span><span class="m">2</span><span class="nb">)</span>         <span class="c">; Remove arguments from the stack</span>
  <span class="k">return</span>
</pre></div>
</div>
<p>You can use the <tt class="docutils literal"><span class="pre">getstackat()</span></tt> macro to retrieve values from the stack one at a time in any order.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nl">my_func3:</span>
  <span class="nb">getstackat(</span><span class="s">s4</span><span class="p">,</span> <span class="m">1</span><span class="nb">)</span>    <span class="c">; Retrieve second argument (SP + 1)</span>
  <span class="nb">getstackat(</span><span class="s">s3</span><span class="p">,</span> <span class="m">2</span><span class="nb">)</span>    <span class="c">; Retrieve first argument  (SP + 2)</span>
  <span class="ge">&lt;Do your business&gt;</span>
  <span class="nb">dropstack(</span><span class="m">2</span><span class="nb">)</span>         <span class="c">; Remove arguments from the stack</span>
  <span class="k">return</span>
</pre></div>
</div>
<p>You may wish to allocate temporary space on the stack for local variables in a function. Use the <tt class="docutils literal"><span class="pre">addstack()</span></tt> and <tt class="docutils literal"><span class="pre">addstackreg()</span></tt> macros to accomplish this. <tt class="docutils literal"><span class="pre">putstack()</span></tt> and <tt class="docutils literal"><span class="pre">putstackat()</span></tt> are used to store register values on the stack.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nl">my_func4:</span>
  <span class="nb">addstack(</span><span class="m">4</span><span class="nb">)</span>              <span class="c">; Add 4 bytes to the stack to work with</span>
  <span class="nb">putstack(</span><span class="s">s0</span><span class="p">,</span> <span class="s">s1</span><span class="p">,</span> <span class="s">s2</span><span class="p">,</span> <span class="s">s3</span><span class="nb">)</span>
  <span class="nb">getstackat(</span><span class="s">s4</span><span class="p">,</span> <span class="m">2</span><span class="nb">)</span>
  <span class="nb">dropstack(</span><span class="m">4</span><span class="nb">)</span>             <span class="c">; Remove local frame</span>
</pre></div>
</div>
</div>
<div class="section" id="bitfield-operations">
<span id="bitfield-manipulations"></span><h2>Bitfield operations<a class="headerlink" href="#bitfield-operations" title="Permalink to this headline">Â¶</a></h2>
<p>A set of macros are available to manipulate bitfields without manually constructing hex masks.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">f0</span>
<span class="nb">setbit(</span><span class="s">s0</span><span class="p">,</span> <span class="m">0</span><span class="nb">)</span>                <span class="c">; s0 = f1</span>
<span class="nb">setbit(</span><span class="s">s0</span><span class="p">,</span> <span class="m">2</span><span class="nb">)</span>                <span class="c">; s0 = f5</span>
<span class="nb">clearbit(</span><span class="s">s0</span><span class="p">,</span> <span class="m">7</span><span class="nb">)</span>              <span class="c">; s0 = 75</span>

<span class="nb">setmask(</span><span class="s">s0</span><span class="p">,</span> <span class="nb">mask(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="nb">))</span>   <span class="c">; s0 = 7f</span>
<span class="nb">clearmask(</span><span class="s">s0</span><span class="p">,</span> <span class="nb">mask(</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">6</span><span class="p">,</span><span class="m">7</span><span class="nb">))</span> <span class="c">; s0 = 0f</span>

<span class="nb">testbit(</span><span class="s">s0</span><span class="p">,</span> <span class="m">0</span><span class="nb">)</span>               <span class="c">; Test if bit-0 is set or clear</span>
<span class="k">jump</span> <span class="n">nz</span><span class="p">,</span> <span class="n">somewhere</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">maskh()</span></tt> macro works like <tt class="docutils literal"><span class="pre">mask()</span></tt> but produces a result in PicoBlaze hex format so it can be used as a direct argument to any instruction that takes a constant.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="nb">maskh(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">6</span><span class="p">,</span><span class="m">7</span><span class="nb">)</span>  <span class="c">; Expands to &quot;load s0, c7&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="shift-and-rotate">
<span id="shift-and-rotate-by-multiple-bits"></span><h2>Shift and rotate<a class="headerlink" href="#shift-and-rotate" title="Permalink to this headline">Â¶</a></h2>
<p>Shifts and rotates are inconvenient in PicoBlaze assembly because they must be performed one bit at a time. Macros are provided that generate shifts and rotates by any number of bits more easily.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">01</span>
<span class="nb">sl0(</span><span class="s">s0</span><span class="p">,</span> <span class="m">4</span><span class="nb">)</span>  <span class="c">; Shift left by 4 bits  s0 = 00010000&#39;b</span>
<span class="nb">sr1(</span><span class="s">s0</span><span class="p">,</span> <span class="m">3</span><span class="nb">)</span>  <span class="c">; Shift right by 3 bits with 1&#39;s inserted  s0 = 11100010&#39;b</span>
</pre></div>
</div>
<p>All 10 of the PicoBlaze shift and an rotate instructions have macro equivalents. The original instructions can still be used as usual.</p>
</div>
<div class="section" id="conditional-jump-call-and-return">
<span id="id1"></span><h2>Conditional jump call and return<a class="headerlink" href="#conditional-jump-call-and-return" title="Permalink to this headline">Â¶</a></h2>
<p>PicoBlaze assembly depends on using the carry and zero flags directly to handle conditional jump and call instructions. It can be difficult to remember how the carry flag is interpreted so a set of macros are provided to perform more natural conditional instructions.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">compare</span> <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span>
<span class="nb">jne(</span><span class="s">not_equal</span><span class="nb">)</span>           <span class="c">; Jump if s0 != s1</span>
<span class="nb">jeq(</span><span class="s">equal</span><span class="nb">)</span>               <span class="c">; Jump if s0 == s1</span>
<span class="nb">jge(</span><span class="s">greater_or_equal</span><span class="nb">)</span>    <span class="c">; Jump if s0 &gt;= s1</span>
<span class="nb">jlt(</span><span class="s">less_than</span><span class="nb">)</span>           <span class="c">; Jump if s0 &lt; s1</span>

<span class="nb">callne(</span><span class="s">not_equal</span><span class="nb">)</span>        <span class="c">; Call if s0 != s1</span>
<span class="nb">calleq(</span><span class="s">equal</span><span class="nb">)</span>            <span class="c">; Call if s0 == s1</span>
<span class="nb">callge(</span><span class="s">greater_or_equal</span><span class="nb">)</span> <span class="c">; Call if s0 &gt;= s1</span>
<span class="nb">calllt(</span><span class="s">less_than</span><span class="nb">)</span>        <span class="c">; Call if s0 &lt; s1</span>

<span class="k">retne</span>                    <span class="c">; Return if s0 != s1</span>
<span class="k">reteq</span>                    <span class="c">; Return if s0 == s1</span>
<span class="k">retge</span>                    <span class="c">; Return if s0 &gt;= s1</span>
<span class="k">retlt</span>                    <span class="c">; Return if s0 &lt; s1</span>
</pre></div>
</div>
</div>
<div class="section" id="conditional-if-then-else">
<h2>Conditional if-then-else<a class="headerlink" href="#conditional-if-then-else" title="Permalink to this headline">Â¶</a></h2>
<p>A high level <tt class="docutils literal"><span class="pre">if()</span></tt> macro is present that provides evaluation of infix Boolean expressions. It takes the form of <tt class="docutils literal"><span class="pre">if(&lt;expr&gt;,&lt;true</span> <span class="pre">block&gt;,[&lt;expr&gt;,&lt;true</span> <span class="pre">block</span> <span class="pre">2&gt;...|&lt;else</span> <span class="pre">block&gt;])</span></tt>. The expression syntax uses conventional C operators ==, !=, &lt;, ,&gt;=, &gt;, &lt;=, and &amp;. Additional expressions after the first true block produce else-if evaluation similar to m4&#8217;s <tt class="docutils literal"><span class="pre">ifelse()</span></tt> macro. It is important to guard code blocks with m4 quotes to avoid errors caused by m4 splitting strings with internal commas. The <tt class="docutils literal"><span class="pre">if()</span></tt> macro implements a <tt class="docutils literal"><span class="pre">COMPARE</span></tt> instruction and generates the appropriate branch logic to test the flags. Unique generated labels are inserted into the code to manage the sequencing of the code blocks.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">05</span>
<span class="nb">if(</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">,</span>
  <span class="s">`load</span> <span class="s">s1</span><span class="p">,</span> <span class="s">&quot;T&quot;</span>
  <span class="s">output</span> <span class="s">s1</span><span class="p">,</span> <span class="m">00</span><span class="s">&#39;</span><span class="p">,</span>
<span class="s">;</span> <span class="s">else</span><span class="o">-</span><span class="s">if</span>
<span class="s">s0</span> <span class="o">&lt;</span> <span class="m">8</span><span class="p">,</span>
  <span class="s">`load</span> <span class="s">s1</span><span class="p">,</span> <span class="s">&quot;t&quot;</span>
  <span class="s">output</span> <span class="s">s1</span><span class="p">,</span> <span class="m">01</span><span class="s">&#39;</span><span class="p">,</span>
<span class="s">;else</span>
  <span class="s">`load</span> <span class="s">s1</span> <span class="s">&quot;F&quot;</span>
  <span class="s">output</span> <span class="s">s1</span><span class="p">,</span> <span class="m">02</span><span class="s">&#39;</span>
<span class="nb">)</span>
</pre></div>
</div>
<p>In addition, the &amp; operator can be used to generate a <tt class="docutils literal"><span class="pre">TEST</span></tt> instruction instead of <tt class="docutils literal"><span class="pre">COMPARE</span></tt>. The true block is executed if the test result is non-zero:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="c">; Check if MSB is set</span>
<span class="nb">if(</span><span class="s">s0</span> <span class="s">&amp;</span> <span class="mh">0x80</span><span class="p">,</span> <span class="s">`load</span> <span class="s">s1</span><span class="p">,</span> <span class="m">00</span><span class="s">&#39;</span><span class="nb">)</span>
</pre></div>
</div>
<p>You can invoke signed comparison using the <tt class="docutils literal"><span class="pre">comapres()</span></tt> macro by wrapping the expression in <tt class="docutils literal"><span class="pre">signed()</span></tt>:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span> <span class="nb">evalh(</span><span class="o">-</span><span class="m">10</span><span class="nb">)</span> <span class="c">; -10 = 0xF6 which evaluates as &gt; 5 in unsigned comparison</span>
<span class="nb">if(signed(</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="m">5</span><span class="nb">)</span><span class="p">,</span><span class="s">`load</span> <span class="s">s1</span><span class="p">,</span> <span class="m">00</span><span class="s">&#39;</span><span class="nb">)</span> <span class="c">; evaluate as &lt; 5 using signed comparison</span>
</pre></div>
</div>
<p>Macros can be used within the code blocks including nested <tt class="docutils literal"><span class="pre">if()</span></tt> macros:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">if(</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="s">s1</span><span class="p">,</span>
   <span class="s">`&lt;something&gt;&#39;</span><span class="p">,</span>
<span class="s">;</span> <span class="s">else</span>
  <span class="s">`if(s2</span> <span class="o">&gt;</span><span class="s">=</span> <span class="s">s3</span><span class="p">,</span><span class="s">`&lt;something</span> <span class="s">else</span><span class="o">&gt;</span><span class="s">&#39;</span><span class="nb">)</span>&#39;
)
</pre></div>
</div>
<div class="section" id="c-style-syntax">
<h3>C-style syntax<a class="headerlink" href="#c-style-syntax" title="Permalink to this headline">Â¶</a></h3>
<p>The m4 syntax for the <tt class="docutils literal"><span class="pre">if()</span></tt> macro is a little untidy but an alternate C-style syntax can be used. It is implemented using an initial preprocessing step where pattern matching converts C-style control flow statements into m4 syntax. Instead of m4 quotes, code blocks are surrounded by mandatory curly braces. Unlike m4 macros, whitespace is permitted between the <tt class="docutils literal"><span class="pre">if</span></tt> keyword and its comparison expression.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">if (</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="s">s1</span><span class="nb">)</span> <span class="p">{</span>
  <span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="sc">&quot;T&quot;</span>
<span class="p">}</span> <span class="nb">else</span> <span class="nb">if (</span><span class="s">s2</span> <span class="o">==</span> <span class="s">s3</span><span class="nb">)</span> <span class="p">{</span>
  <span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="sc">&quot;t&quot;</span>
<span class="p">}</span> <span class="nb">else</span> <span class="p">{</span>
  <span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="sc">&quot;F&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A set of lower level if-then-else macros are provided to expose the internal workings of <tt class="docutils literal"><span class="pre">if()</span></tt>. The macros are <tt class="docutils literal"><span class="pre">ifeq()</span></tt>, <tt class="docutils literal"><span class="pre">ifne()</span></tt>, <tt class="docutils literal"><span class="pre">ifge()</span></tt>, and <tt class="docutils literal"><span class="pre">iflt()</span></tt>. Unlike <tt class="docutils literal"><span class="pre">if()</span></tt>, no <tt class="docutils literal"><span class="pre">COMPARE</span></tt> or <tt class="docutils literal"><span class="pre">TEST</span></tt> instruction is generated from an expression. You have to prepare the flags on your own. The first argument is the code to execute for the true condition. An optional second argument is used for the else clause.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">compare</span> <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span>
<span class="nb">ifeq(</span>
  <span class="s">`load</span> <span class="s">s4</span><span class="p">,</span> <span class="m">20</span>
   <span class="s">output</span> <span class="s">s4</span><span class="p">,</span> <span class="s">PORT&#39;</span><span class="p">,</span>
<span class="s">;</span> <span class="s">else</span>
  <span class="s">`load</span> <span class="s">s4</span><span class="p">,</span> <span class="m">30</span>
   <span class="s">output</span> <span class="s">s4</span><span class="p">,</span> <span class="s">PORT2&#39;</span><span class="nb">)</span>
</pre></div>
</div>
<p>This expands to the following:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">compare</span> <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span>
<span class="k">jump</span> <span class="n">nz</span><span class="p">,</span> <span class="n">NEQ_f1_0001</span>
<span class="k">load</span> <span class="n">s4</span><span class="p">,</span> <span class="mh">20</span>
   <span class="k">output</span> <span class="n">s4</span><span class="p">,</span> <span class="n">PORT</span>
<span class="k">jump</span> <span class="n">ENDIF_f1_0002</span>
<span class="nl">NEQ_f1_0001:</span>
<span class="c">; else</span>
  <span class="k">load</span> <span class="n">s4</span><span class="p">,</span> <span class="mh">30</span>
   <span class="k">output</span> <span class="n">s4</span><span class="p">,</span> <span class="n">PORT2</span>
<span class="nl">ENDIF_f1_0002:</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="looping">
<h2>Looping<a class="headerlink" href="#looping" title="Permalink to this headline">Â¶</a></h2>
<p>Similarly to <tt class="docutils literal"><span class="pre">if()</span></tt> there are a set of high level looping macros <tt class="docutils literal"><span class="pre">for()</span></tt>, <tt class="docutils literal"><span class="pre">while()</span></tt>, and <tt class="docutils literal"><span class="pre">dowhile()</span></tt>. They implement the corresponding looping constructs using the syntax <tt class="docutils literal"><span class="pre">for(&lt;init&gt;,&lt;expr&gt;,&lt;update&gt;,&lt;loop</span> <span class="pre">body&gt;)</span></tt> and <tt class="docutils literal"><span class="pre">[do]while(&lt;expr&gt;,&lt;loop</span> <span class="pre">body&gt;)</span></tt>. Signed comparison is supported just as with <tt class="docutils literal"><span class="pre">if()</span></tt> using the <tt class="docutils literal"><span class="pre">signed()</span></tt> macro as a modifier. The for loop macro uses the <tt class="docutils literal"><span class="pre">expr()</span></tt> macro syntax for the <em>init</em> and <em>update</em> fields.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">for(</span><span class="s">s0</span> <span class="o">:=</span> <span class="o">-</span><span class="m">10</span><span class="p">,</span> <span class="nb">signed(</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="m">10</span><span class="nb">)</span><span class="p">,</span> <span class="s">s0</span> <span class="o">:=</span> <span class="s">s0</span> <span class="o">+</span> <span class="m">1</span><span class="p">,</span>
  <span class="s">`output</span> <span class="s">s1</span><span class="p">,</span> <span class="s">P_FOO&#39;</span>
<span class="nb">)</span>
</pre></div>
</div>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="c">; Output s1 to port 00 10 times</span>
<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>
<span class="nb">while(</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="m">10</span><span class="p">,</span>
  <span class="s">`output</span> <span class="s">s1</span><span class="p">,</span> <span class="s">P_FOO</span>
   <span class="s">add</span> <span class="s">s0</span><span class="p">,</span> <span class="m">01</span><span class="s">&#39;</span>
<span class="nb">)</span>
</pre></div>
</div>
<div class="section" id="id2">
<h3>C-style syntax<a class="headerlink" href="#id2" title="Permalink to this headline">Â¶</a></h3>
<p>Similarly to the <tt class="docutils literal"><span class="pre">if()</span></tt> macro, an alternate C-style syntax is available for <tt class="docutils literal"><span class="pre">for()</span></tt>, <tt class="docutils literal"><span class="pre">while()</span></tt>, and <tt class="docutils literal"><span class="pre">dowhile()</span></tt>. Note that the <tt class="docutils literal"><span class="pre">for()</span></tt> macro continues to use commas to separate the sections.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">for (</span><span class="s">s0</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="s">s0</span> <span class="o">&lt;</span> <span class="s">s1</span><span class="p">,</span> <span class="s">s0</span> <span class="o">:=</span> <span class="s">s0</span> <span class="o">+</span> <span class="m">1</span><span class="nb">)</span> <span class="p">{</span>
  <span class="k">output</span> <span class="n">s0</span><span class="p">,</span> <span class="n">P_FOO</span>
<span class="p">}</span>

<span class="nb">while (</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="s">s1</span><span class="nb">)</span> <span class="p">{</span>
  <span class="k">add</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">01</span>
  <span class="k">output</span> <span class="n">s0</span><span class="p">,</span> <span class="n">P_FOO</span>
<span class="p">}</span>

<span class="k">do</span> {
  <span class="k">add</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">01</span>
  <span class="k">output</span> <span class="n">s0</span><span class="p">,</span> <span class="n">P_FOO</span>
<span class="p">}</span> <span class="nb">while (</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="s">s1</span><span class="nb">)</span>
</pre></div>
</div>
<p>Two macros, <tt class="docutils literal"><span class="pre">break</span></tt> and <tt class="docutils literal"><span class="pre">continue</span></tt>, are available to exit the current loop and restart a loop respectively. In a for loop the <tt class="docutils literal"><span class="pre">continue</span></tt> macro will execute the <em>update</em> field expression to prepare the next iteration.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="c">; &quot;continue&quot; resumes execution here</span>
<span class="nb">while (</span><span class="s">s0</span> <span class="o">&lt;</span> <span class="s">s1</span><span class="nb">)</span> <span class="p">{</span>
  <span class="k">add</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">01</span>
  <span class="nb">if (</span><span class="s">s3</span> <span class="o">==</span> <span class="m">4</span><span class="nb">)</span> <span class="p">{</span> <span class="k">continue</span> }
  <span class="nb">if (</span><span class="s">s2</span> <span class="o">==</span> <span class="m">5</span><span class="nb">)</span> <span class="p">{</span> <span class="k">break</span> }
  <span class="k">output</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>
<span class="p">}</span>
<span class="c">; &quot;break&quot; resumes execution here</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="delay-generators">
<h2>Delay generators<a class="headerlink" href="#delay-generators" title="Permalink to this headline">Â¶</a></h2>
<p>A set of delay generator macros are available to implement software delays. The simplest is <tt class="docutils literal"><span class="pre">delay_cycles()</span></tt> which delays by a number of instruction cycles (each being two clock cycles). It is implemented with recursive loops and requires no registers to function.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">delay_cycles(</span><span class="m">40</span><span class="nb">)</span>   <span class="c">; Delay for 40 instructions (80 clock periods)</span>
</pre></div>
</div>
<p>This expands to the following recursive code implemented in 13 instructions:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre>                   <span class="k">CALL</span> <span class="n">DTREE_f1_0001_4</span>           <span class="c">; Delay for 33 cycles</span>
                   <span class="k">JUMP</span> <span class="n">DTREE_f1_0001_end</span>
  <span class="nl">DTREE_f1_0001_4:</span> <span class="k">CALL</span> <span class="n">DTREE_f1_0001_3</span>
  <span class="nl">DTREE_f1_0001_3:</span> <span class="k">CALL</span> <span class="n">DTREE_f1_0001_2</span>
  <span class="nl">DTREE_f1_0001_2:</span> <span class="k">CALL</span> <span class="n">DTREE_f1_0001_1</span>
  <span class="nl">DTREE_f1_0001_1:</span> <span class="k">CALL</span> <span class="n">DTREE_f1_0001_0</span>
  <span class="nl">DTREE_f1_0001_0:</span> <span class="k">RETURN</span>
<span class="nl">DTREE_f1_0001_end:</span>
                   <span class="k">CALL</span> <span class="n">DTREE_f1_0002_1</span>           <span class="c">; Delay for 5 cycles</span>
                   <span class="k">JUMP</span> <span class="n">DTREE_f1_0002_end</span>
  <span class="nl">DTREE_f1_0002_1:</span> <span class="k">CALL</span> <span class="n">DTREE_f1_0002_0</span>
  <span class="nl">DTREE_f1_0002_0:</span> <span class="k">RETURN</span>
<span class="nl">DTREE_f1_0002_end:</span>
                   <span class="k">LOAD</span> <span class="n">sf</span><span class="p">,</span> <span class="n">sf</span>                    <span class="c">; NOP</span>
                   <span class="k">LOAD</span> <span class="n">sf</span><span class="p">,</span> <span class="n">sf</span>                    <span class="c">; NOP</span>
</pre></div>
</div>
<p>The delay can be from 0 to approximately 100e9 but a practical limit would be to keep the delay less than 200 cycles to restrict the amount of generated code. You must ensure that there is enough space on the call stack to perform the recursive calls. In the example above the 33-cycle delay block extends five calls deep.</p>
<p>Delays by microseconds and milliseconds are implemented with the <tt class="docutils literal"><span class="pre">delay_us()</span></tt> and <tt class="docutils literal"><span class="pre">delay_ms()</span></tt> macros. Before using these you must establish the system clock frequency with the <tt class="docutils literal"><span class="pre">use_clock()</span></tt> macro. These delays are cycle accurate if the requested delay is an integer multiple of the clock period. They have the ability to adjust the delay by a certain number of instructions if needed.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">use_clock(</span><span class="m">100</span><span class="nb">)</span>                     <span class="c">; 100 MHz system clock</span>

<span class="c">; 10 ms delay subroutine</span>
<span class="nl">delay_10ms:</span> <span class="nb">delay_ms(</span><span class="m">10</span><span class="p">,</span> <span class="s">s4</span><span class="p">,</span><span class="s">s5</span><span class="p">,</span> <span class="m">2</span><span class="nb">)</span> <span class="c">; Adjust delay by 2 instructions for call and return</span>
            <span class="k">return</span>

...
<span class="k">call</span> <span class="n">delay_10ms</span>
<span class="c">; Exactly 10 ms have passed here</span>

...
<span class="nb">delay_ms(</span><span class="m">10</span><span class="p">,</span> <span class="s">s4</span><span class="p">,</span> <span class="s">s5</span><span class="nb">)</span>               <span class="c">; Inline delay by 10 ms</span>
<span class="c">; Exactly 10 ms have passed here</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">delay_*()</span></tt> macros take a delay value, a pair of registers and an optional adjustment as arguments. The delay value is the amount of delay in the associated units. The upper limit depends on the clock frequency. At 100 MHz the maximum delay is 214 ms. The registers are used for an internal 16-bit counter. The internal delay loop is automatically adjusted to ensure the count value fits within 16-bits. When implementing a delay as a subroutine an adjustment can be added to account for the <tt class="docutils literal"><span class="pre">CALL</span></tt> and <tt class="docutils literal"><span class="pre">RETURN</span></tt> instructions.</p>
<p>If you need to use multiple delays it may be desirable to have a common delay routine that supports variable delay counts. This is provided by the <tt class="docutils literal"><span class="pre">var_delay_us()</span></tt> and <tt class="docutils literal"><span class="pre">var_delay_ms()</span></tt> macros. They are similar to the fixed delays but are not cycle accurate and have no provision for adjustment.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">use_clock(</span><span class="m">50</span><span class="nb">)</span>            <span class="c">; 50 MHz system clock</span>

<span class="nb">define(</span><span class="s">MAX_DELAY</span><span class="p">,</span> <span class="m">200</span><span class="nb">)</span>   <span class="c">; Maximum 200 us delay</span>

<span class="nl">var_delay:</span> <span class="nb">var_delay_us(</span><span class="s">MAX_DELAY</span><span class="p">,</span> <span class="s">s4</span><span class="p">,</span><span class="s">s5</span><span class="nb">)</span>
           <span class="k">return</span>
...

<span class="nb">load16(</span><span class="s">s4</span><span class="p">,</span><span class="s">s5</span><span class="p">,</span> <span class="nb">var_count_us(</span><span class="m">20</span><span class="p">,</span> <span class="s">MAX_DELAY</span><span class="nb">))</span>  <span class="c">; 20 us delay</span>
<span class="k">call</span> <span class="n">var_delay</span>
...

<span class="nb">load16(</span><span class="s">s4</span><span class="p">,</span><span class="s">s5</span><span class="p">,</span> <span class="nb">var_count_us(</span><span class="m">150</span><span class="p">,</span> <span class="s">MAX_DELAY</span><span class="nb">))</span> <span class="c">; 150 us delay</span>
<span class="k">call</span> <span class="n">var_delay</span>
</pre></div>
</div>
<p>The first argument to the <tt class="docutils literal"><span class="pre">var_delay_*()</span></tt> macros is the maximum delay value to support. When a delay is needed you must load the count registers with a constant computed with the <tt class="docutils literal"><span class="pre">var_count_*()</span></tt> macros.</p>
</div>
<div class="section" id="string-and-table-operations">
<span id="portable-string-and-table-operations"></span><span id="string-and-table-ops"></span><h2>String and table operations<a class="headerlink" href="#string-and-table-operations" title="Permalink to this headline">Â¶</a></h2>
<p>PicoBlaze-3 doesn&#8217;t have the ability to handle strings as efficiently as PB6 but it is still necessary to work with them at times. Suppose that you have a subroutine &#8220;write_char&#8221; that writes characters in s0 out to a peripheral. You can write entire strings with the following:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">callstring(</span><span class="s">write_char</span><span class="p">,</span> <span class="s">s0</span><span class="p">,</span> <span class="s">`My</span> <span class="s">string&#39;</span><span class="nb">)</span> <span class="c">; Note use of m4 quotes `&#39; to enclose the string</span>
</pre></div>
</div>
<p>This expands to the following:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="sc">&quot;M&quot;</span>
<span class="k">call</span> <span class="n">write_char</span>
<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="sc">&quot;y&quot;</span>
<span class="k">call</span> <span class="n">write_char</span>
<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="sc">&quot; &quot;</span>
<span class="k">call</span> <span class="n">write_char</span>
...
<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="sc">&quot;n&quot;</span>
<span class="k">call</span> <span class="n">write_char</span>
<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="sc">&quot;g&quot;</span>
<span class="k">call</span> <span class="n">write_char</span>
</pre></div>
</div>
<p>Similarly you can call with arbitrary bytes in a table. The <tt class="docutils literal"><span class="pre">pbhex()</span></tt> macro is useful here to express hex numbers with less clutter.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">calltable(</span><span class="s">write_char</span><span class="p">,</span> <span class="s">s0</span><span class="p">,</span>  <span class="nb">pbhex(</span><span class="mh">DE</span><span class="p">,</span> <span class="mh">AD</span><span class="p">,</span> <span class="mh">BE</span><span class="p">,</span> <span class="mh">EF</span><span class="nb">))</span>
</pre></div>
</div>
<p>There are four targets for string and table macros: &#8220;call&#8221;, &#8220;output&#8221;, &#8220;store&#8221;, and &#8220;inst&#8221;. They work similarly to the &#8220;call&#8221; macros above but generate &#8220;output&#8221;, &#8220;store&#8221;, or &#8220;inst&#8221; instructions in place of &#8220;call&#8221;.</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="17%" />
<col width="15%" />
<col width="18%" />
<col width="36%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>callstring</td>
<td>outputstring</td>
<td>storestring</td>
<td>storestringat</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>calltable</td>
<td>outputtable</td>
<td>storetable</td>
<td>storetableat</td>
<td>insttable_le, insttable_be</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal"><span class="pre">storestringat()</span></tt> and <tt class="docutils literal"><span class="pre">storetableat()</span></tt> macros take a register as a pointer to the destination scratchpad address. The pointer register is incremented after storing each byte except for the last.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">constant</span> <span class="n">M_DATA</span><span class="p">,</span> <span class="mh">10</span>
<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="n">M_DATA</span>
<span class="nb">storestringat(</span><span class="s">s0</span><span class="p">,</span> <span class="s">sF</span><span class="p">,</span> <span class="s">`Store</span> <span class="s">this&#39;</span><span class="nb">)</span> <span class="c">; sF is used as a temp register</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">insttable_le()</span></tt> and <tt class="docutils literal"><span class="pre">insttable_be()</span></tt> macros generate packed INST directives for use as static data. The former generates little-endian instructions while the latter is big-endian.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">insttable_le(pbhex(</span><span class="mh">0a</span><span class="p">,</span> <span class="mh">0b</span><span class="p">,</span> <span class="mh">0c</span><span class="nb">))</span>
<span class="c">; Expands to:  inst 00b0a</span>
<span class="c">;              inst 0000c</span>

<span class="nb">insttable_be(pbhex(</span><span class="mh">0a</span><span class="p">,</span> <span class="mh">0b</span><span class="p">,</span> <span class="mh">0c</span><span class="nb">))</span>
<span class="c">; Expands to:  inst 00a0b</span>
<span class="c">;              inst 00c00</span>
</pre></div>
</div>
<p>The insttable macros only accept a list of decimal values directly but the <tt class="docutils literal"><span class="pre">asciiord()</span></tt> macro can be used to convert strings to numeric data.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">insttable_le(asciiord(</span><span class="s">`Pack</span> <span class="s">strings</span> <span class="s">into</span> <span class="s">ROM&#39;</span><span class="nb">))</span>
<span class="c">; Expands to:</span>
  <span class="k">inst</span> <span class="mh">06150</span>
  <span class="k">inst</span> <span class="mh">06b63</span>
  <span class="k">inst</span> <span class="mh">07320</span>
  ...
  <span class="k">inst</span> <span class="mh">0206f</span>
  <span class="k">inst</span> <span class="mh">04f52</span>
  <span class="k">inst</span> <span class="mh">0004d</span>
</pre></div>
</div>
<p>This permits the compact storage of data bytes in the PicoBlaze ROM. If synthesized as a dual-ported block RAM, the data can be retrieved with external logic. The <tt class="docutils literal"><span class="pre">picoblaze_dp_rom</span></tt> component included with <a class="reference external" href="https://code.google.com/p/opbasm/source/browse/templates/picoblaze_rom.vhdl">picoblaze_rom.vhdl</a> provides a second read/write port for this purpose.</p>
<div class="section" id="escaped-strings">
<h3>Escaped strings<a class="headerlink" href="#escaped-strings" title="Permalink to this headline">Â¶</a></h3>
<p>The native PicoBlaze syntax does not permit the use of character escapes in strings. The macros <tt class="docutils literal"><span class="pre">estr()</span></tt> and <tt class="docutils literal"><span class="pre">cstr()</span></tt> provide a means for generating escaped strings without and with a NUL terminator respectively. They generate a list of integers representing each character in the string. The following C-style backslash escape codes are supported:</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="77%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Escape</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><cite>\\</cite></td>
<td>Literal &#8220;\&#8221;</td>
</tr>
<tr class="row-odd"><td>\n</td>
<td>Newline \ Line Feed</td>
</tr>
<tr class="row-even"><td>\r</td>
<td>Carriage Return</td>
</tr>
<tr class="row-odd"><td>\b</td>
<td>Backspace</td>
</tr>
<tr class="row-even"><td>\a</td>
<td>Bell</td>
</tr>
<tr class="row-odd"><td>\e</td>
<td>Esc</td>
</tr>
<tr class="row-even"><td>\s</td>
<td>Literal semicolon</td>
</tr>
</tbody>
</table>
<p>On PicoBlaze-6 you can apply the output of these macros directly in a <tt class="docutils literal"><span class="pre">TABLE</span></tt> directive as follows:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">table</span> <span class="n">hello#</span><span class="p">,</span> <span class="mh">[dec2pbhex(cstr(`Hello\r\n&#39;))]</span>
<span class="c">; This expands to: table hello#, [48, 65, 6c, 6c, 6f, 0d, 0a, 00]</span>

<span class="k">table</span> <span class="n">hello2#</span><span class="p">,</span> <span class="mh">[dec2pbhex(estr(`Hello\r\n&#39;))]</span>
<span class="c">; This expands to: table hello2#, [48, 65, 6c, 6c, 6f, 0d, 0a]</span>
</pre></div>
</div>
<p>For PicoBlaze-3 you can pass the output of <tt class="docutils literal"><span class="pre">estr()</span></tt> and <tt class="docutils literal"><span class="pre">cstr()</span></tt> to the <tt class="docutils literal"><span class="pre">call/store/outputtable()</span></tt> macros or use the portable string macros described next.</p>
<p>If you need know the length of a string constant you can use <tt class="docutils literal"><span class="pre">strlen()</span></tt> to generate that value. It takes a single string argument that can contain escaped characters. It is passed through <tt class="docutils literal"><span class="pre">estr()</span></tt> before characters are counted.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="nb">strlen(</span><span class="s">`foobar\r\n&#39;</span><span class="nb">)</span> <span class="c">; Expands to 8</span>
</pre></div>
</div>
<p>You can also pass the label to a string defined with <tt class="docutils literal"><span class="pre">string()</span></tt> or <tt class="docutils literal"><span class="pre">packed_string()</span></tt> to retrieve their length.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">packed_string(</span><span class="s">my_string</span><span class="p">,</span> <span class="s">`This</span> <span class="s">is</span> <span class="s">a</span> <span class="s">string&#39;</span><span class="nb">)</span>
<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="nb">strlen(</span><span class="s">my_string</span><span class="nb">)</span> <span class="c">; Expands to 16</span>
</pre></div>
</div>
<p>Note that m4 has a builtin macro <tt class="docutils literal"><span class="pre">len()</span></tt> that also returns the length of strings. However, it does not account for escape characters and will include blackslashes in its count.</p>
</div>
<div class="section" id="portable-strings">
<h3>Portable strings<a class="headerlink" href="#portable-strings" title="Permalink to this headline">Â¶</a></h3>
<p>A simplified system for generating efficient, portable strings is provided by the macro package. With this you can create string handling code that will expand into the most efficient form for PicoBlaze-3 or PicoBlaze-6. You must configure the portable string system with the <tt class="docutils literal"><span class="pre">use_strings()</span></tt> macro. It configures the registers and a character handling routine used when processing a string.</p>
<ul class="simple">
<li>Arg1: Register loaded with each character</li>
<li>Arg2, Arg3: MSB, LSB of string address (Only used on PB6. Use dummy registers for PB3)</li>
<li>Arg4: Label of a user provided function called to process each character</li>
</ul>
<p>After configuring string handling with <tt class="docutils literal"><span class="pre">use_strings()</span></tt> you must define each string using the <tt class="docutils literal"><span class="pre">string()</span></tt> macro. It takes two arguments. The first is a label to identify the string and the second is the escaped string value. Strings are reproduced by calling them with the label used in their definition. Labels should not end with a &#8220;$&#8221; like with the <tt class="docutils literal"><span class="pre">STRING</span></tt> directive.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">jump</span> <span class="n">main</span>
<span class="nb">use_strings(</span><span class="s">s0</span><span class="p">,</span> <span class="s">s5</span><span class="p">,</span><span class="s">s6</span><span class="p">,</span> <span class="s">write_char</span><span class="nb">)</span>

<span class="nl">write_char:</span> <span class="k">output</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>
            <span class="k">return</span>

<span class="nb">string(</span><span class="s">hello</span><span class="p">,</span> <span class="s">`Hello</span> <span class="s">world\r\n&#39;</span><span class="nb">)</span> <span class="c">; Define a string called &quot;hello&quot;</span>

<span class="nl">main:</span>
...
<span class="k">call</span> <span class="n">hello</span> <span class="c">; Call write_char on each character in the &quot;hello&quot; string</span>
</pre></div>
</div>
<p>This expands to the following when targeting PB6:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre>                  <span class="k">JUMP</span> <span class="n">main</span>
                  <span class="c">; PB6 common string handler routine</span>
<span class="nl">__string_handler:</span> <span class="k">CALL@</span> <span class="p">(</span><span class="n">s5</span><span class="p">,</span> <span class="n">s6</span><span class="p">)</span>                 <span class="c">; Read next char</span>
                  <span class="k">COMPARE</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>                 <span class="c">; Check if NUL</span>
                  <span class="k">RETURN</span> <span class="n">z</span>
                  <span class="k">CALL</span> <span class="n">write_char</span>                <span class="c">; Handle the char</span>
                  <span class="k">ADD</span> <span class="n">s6</span><span class="p">,</span> <span class="mh">01</span>                     <span class="c">; 1</span>
                  <span class="k">ADDCY</span> <span class="n">s5</span><span class="p">,</span> <span class="mh">00</span>                   <span class="c">; Increment address</span>
                  <span class="k">JUMP</span> <span class="n">__string_handler</span>

      <span class="nl">write_char:</span> <span class="k">OUTPUT</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>                  <span class="c">; Our character handler</span>
                  <span class="k">RETURN</span>

                  <span class="c">; &quot;Hello world\r\n&quot;</span>
                  <span class="k">TABLE</span> <span class="n">hello#</span><span class="p">,</span> <span class="mh">[48, 65, 6c, 6c, 6f, 20, 77, 6f, 72, 6c, 64, 0d, 0a, 00]</span>
           <span class="nl">hello:</span> <span class="k">LOAD</span> <span class="n">s5</span><span class="p">,</span> <span class="n">_hello_STR</span><span class="o">&#39;upper</span>
                  <span class="k">LOAD</span> <span class="n">s6</span><span class="p">,</span> <span class="n">_hello_STR</span><span class="o">&#39;lower</span>
                  <span class="k">JUMP</span> <span class="n">__string_handler</span>
      <span class="nl">_hello_STR:</span> <span class="k">LOAD&amp;RETURN</span> <span class="n">s0</span><span class="p">,</span> <span class="n">hello#</span>         <span class="c">; Define a string called `&quot;hello&quot;&#39;</span>

            <span class="nl">main:</span>
                  ...
                  <span class="k">CALL</span> <span class="n">hello</span>                     <span class="c">; Call write_char on each character in the &quot;hello&quot; string</span>
</pre></div>
</div>
<p>Note that a common string processing routine <tt class="docutils literal"><span class="pre">__string_handler</span></tt> is generated and the escaped string is implemented with <tt class="docutils literal"><span class="pre">load&amp;return</span></tt> instructions.</p>
<p>When targeting PB3 the following expansion results:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre>            <span class="k">JUMP</span> <span class="n">main</span>

<span class="nl">write_char:</span> <span class="k">OUTPUT</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>                  <span class="c">; Our character handler</span>
            <span class="k">RETURN</span>

            <span class="c">; &quot;Hello world\r\n&quot;</span>
     <span class="nl">hello:</span> <span class="k">LOAD</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">48</span>
            <span class="k">CALL</span> <span class="n">write_char</span>
            <span class="k">LOAD</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">65</span>
            <span class="k">CALL</span> <span class="n">write_char</span>
            <span class="k">LOAD</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">6c</span>
            <span class="k">CALL</span> <span class="n">write_char</span>
            <span class="k">LOAD</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">6c</span>
            <span class="k">CALL</span> <span class="n">write_char</span>
            ...
            <span class="k">LOAD</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">0d</span>
            <span class="k">CALL</span> <span class="n">write_char</span>
            <span class="k">LOAD</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">0a</span>
            <span class="k">CALL</span> <span class="n">write_char</span>
            <span class="k">RETURN</span>                         <span class="c">; Define a string called `&quot;hello&quot;&#39;</span>

      <span class="nl">main:</span>
            ...
            <span class="k">CALL</span> <span class="n">hello</span>                     <span class="c">; Call write_char on each character in the &quot;hello&quot; string</span>
</pre></div>
</div>
<p>The PB3 version does not generate a common handler routine but instead generates code to handle each string in place using the <tt class="docutils literal"><span class="pre">calltable()</span></tt> macro.</p>
<p>You are limited to a single user provided function for processing each character in a string. If you need to perform different operations on strings then you will have to use a register or scratchpad value to select the desired behavior before calling the string label and write a handler routine that checks what operation is needed for each character it receives.</p>
</div>
<div class="section" id="packed-strings">
<h3>Packed strings<a class="headerlink" href="#packed-strings" title="Permalink to this headline">Â¶</a></h3>
<p>A set of macros for handling packed strings is available for use. These work similarly to the portable string macros but rely on character data packed with <tt class="docutils literal"><span class="pre">INST</span></tt> directives. This is the most efficient way to store uncompressed strings in PicoBlaze memory. Access to the data must be implemented with external hardware that can read instruction memory through a second port. The same code is generated for both PB3 and PB6.</p>
<p>To configure packed strings you need to call the <tt class="docutils literal"><span class="pre">use_packed_strings()</span></tt> macro. It is similar to <tt class="docutils literal"><span class="pre">use_strings()</span></tt> but you also need to provide a function that retrieves character pairs from an address in memory. Its arguments are the following:</p>
<ul class="simple">
<li>Arg1: Register to store even characters (0, 2, 4, ...)</li>
<li>Arg2: Register to store odd characters  (1, 3, 5, ...)</li>
<li>Arg3, Arg4: Registers for MSB, LSB of address to string</li>
<li>Arg5: Label of user provided function called to process each character (Only needs to handle the even char register)</li>
<li>Arg6: Label of user provided function called to read pairs of characters from memory</li>
</ul>
<p>Character pairs are stored in big-endian order. The read routine needs to place the upper byte in the even register and the lower byte in the odd register. A common handler routine <tt class="docutils literal"><span class="pre">__packed_string_handler</span></tt> is generated so you must ensure the execution path bypasses the generated code.</p>
<p>After configuration you define strings with the <tt class="docutils literal"><span class="pre">packed_string()</span></tt> macro just as with the <tt class="docutils literal"><span class="pre">string()</span></tt> macro.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">jump</span> <span class="n">main</span>
<span class="nb">mem16(</span><span class="s">P_ROM</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span><span class="mh">0x0a</span><span class="nb">)</span>            <span class="c">; Define 16-bit port addresses for dual-ported ROM</span>
<span class="nb">use_packed_strings(</span><span class="s">s0</span><span class="p">,</span><span class="s">s1</span><span class="p">,</span> <span class="s">s5</span><span class="p">,</span><span class="s">s6</span><span class="p">,</span> <span class="s">write_char</span><span class="p">,</span> <span class="s">read_next_chars</span><span class="nb">)</span>

<span class="nl">write_char:</span> <span class="k">output</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>          <span class="c">; Using register for even chars</span>
            <span class="k">return</span>

<span class="nl">read_next_chars:</span>
            <span class="nb">output16(</span><span class="s">s5</span><span class="p">,</span><span class="s">s6</span><span class="p">,</span> <span class="s">P_ROM</span><span class="nb">)</span> <span class="c">; Select next address from second port</span>
            <span class="k">nop</span>
            <span class="nb">input16(</span><span class="s">s0</span><span class="p">,</span><span class="s">s1</span><span class="p">,</span> <span class="s">P_ROM</span><span class="nb">)</span>  <span class="c">; Read back upper and lower byte</span>
            <span class="k">return</span>

<span class="nb">packed_string(</span><span class="s">hello</span><span class="p">,</span> <span class="s">`Hello</span> <span class="s">world\r\n&#39;</span><span class="nb">)</span> <span class="c">; Define a packed string called &quot;hello&quot;</span>

<span class="nl">main:</span>
...
<span class="k">call</span> <span class="n">hello</span> <span class="c">; Call write_char on each character in the &quot;hello&quot; string</span>
</pre></div>
</div>
<p>If you have existing code using the portable string macros, you can convert it to use packed strings by redefining the <tt class="docutils literal"><span class="pre">string()</span></tt> macro:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">define(</span><span class="s">`string&#39;</span><span class="p">,</span> <span class="s">`packed_string($@</span><span class="nb">)</span>&#39;)
</pre></div>
</div>
</div>
</div>
<div class="section" id="bit-arithmetic">
<h2>8-bit arithmetic<a class="headerlink" href="#bit-arithmetic" title="Permalink to this headline">Â¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">not()</span></tt> and <tt class="docutils literal"><span class="pre">negate()</span></tt> macros are available to perform logical inversion and 2&#8217;s complement negation on 8-bit registers. The <tt class="docutils literal"><span class="pre">abs()</span></tt> macro produces the absolute value of signed registers.</p>
<p>You can perform signed comparison with the <tt class="docutils literal"><span class="pre">compares()</span></tt> macro. It takes the same arguments as the native <tt class="docutils literal"><span class="pre">COMPARE</span></tt> instruction. The <tt class="docutils literal"><span class="pre">C</span></tt> flag is set in accordance with their signed relationship. However, the <tt class="docutils literal"><span class="pre">Z</span></tt> flag is not set correctly. Use the <tt class="docutils literal"><span class="pre">COMPARE</span></tt> instruction to test for equality or inequality of signed values.</p>
<p>If you need to convert an 8-bit signed value to 16-bit, use the <tt class="docutils literal"><span class="pre">signex(&lt;MSB&gt;,</span> <span class="pre">&lt;LSB&gt;)</span></tt> macro to extend the sign bit onto the upper register. The 8-bit register to be extended is passed in as the LSB argument.</p>
</div>
<div class="section" id="bit-arithmetic-logical-and-shift-operators">
<span id="id3"></span><h2>16-bit arithmetic<a class="headerlink" href="#bit-arithmetic-logical-and-shift-operators" title="Permalink to this headline">Â¶</a></h2>
<p>Consider that you need to do some 16-bit arithmetic. You can define aliases for
pairs of 8-bit registers with <tt class="docutils literal"><span class="pre">reg16()</span></tt> and then pass them into the 16-bit arithmetic macros:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">reg16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s4</span><span class="p">,</span> <span class="s">s3</span><span class="nb">)</span>      <span class="c">; Virtual 16-bit register rx is composed of (s4, s3)</span>
<span class="nb">reg16(</span><span class="s">ry</span><span class="p">,</span> <span class="s">s6</span><span class="p">,</span> <span class="s">s5</span><span class="nb">)</span>

<span class="nb">load16(</span><span class="s">rx</span><span class="p">,</span> <span class="m">1000</span><span class="nb">)</span>
<span class="nb">load16(</span><span class="s">ry</span><span class="p">,</span> <span class="m">3000</span> <span class="o">+</span> <span class="m">500</span><span class="nb">)</span> <span class="c">; You can use arbitrary expressions for constants</span>
<span class="nb">add16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">ry</span><span class="nb">)</span>          <span class="c">; rx = rx + ry</span>
<span class="nb">add16(</span><span class="s">rx</span><span class="p">,</span> <span class="o">-</span><span class="m">100</span><span class="nb">)</span>        <span class="c">; rx = rx + (-100)</span>
</pre></div>
</div>
<p>This is much less obtuse than manually calculating 16-bit constants and repeatedly implementing the operations in pieces.</p>
<p>You can retrieve the upper and lower byte registers indirectly with the <tt class="docutils literal"><span class="pre">regupper()</span></tt> and <tt class="docutils literal"><span class="pre">reglower()</span></tt> macros. This makes it easy to reallocate the registers if needed.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="nb">reglower(</span><span class="s">rx</span><span class="nb">)</span> <span class="c">; s0 = s3</span>
<span class="k">load</span> <span class="n">s1</span><span class="p">,</span> <span class="nb">regupper(</span><span class="s">rx</span><span class="nb">)</span> <span class="c">; s1 = s4</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">mem16()</span></tt> macro defines 16-bit constants for scratchpad and port addresses. Like <tt class="docutils literal"><span class="pre">reg16()</span></tt> it creates a new m4 macro that lets you refer to the pair of port addresses together. In addition, two constants are created with the same name suffixed with &#8220;_H&#8221; and &#8220;_L&#8221; to identify the high and low ports respectively.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">mem16(</span><span class="s">M_DATA</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="nb">)</span>
<span class="nb">load16(</span><span class="s">rx</span><span class="p">,</span> <span class="m">1000</span><span class="nb">)</span>
<span class="nb">store16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">M_DATA</span><span class="nb">)</span>
</pre></div>
</div>
<p>The following 16-bit functions are available. All other than <tt class="docutils literal"><span class="pre">not16()</span></tt>, <tt class="docutils literal"><span class="pre">negate16()</span></tt>, and <tt class="docutils literal"><span class="pre">abs16()</span></tt> take a constant or a 16-bit register as their second argument.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="21%" />
<col width="33%" />
<col width="21%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>load16</td>
<td>reg16</td>
<td>mem16</td>
<td>add16</td>
</tr>
<tr class="row-even"><td>sub16</td>
<td>and16</td>
<td>or16</td>
<td>xor16</td>
</tr>
<tr class="row-odd"><td>test16</td>
<td>not16</td>
<td>negate16</td>
<td>abs16</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal"><span class="pre">test16()</span></tt> macro is implemented differently on PicoBlaze-3 due to the lack of the <tt class="docutils literal"><span class="pre">TESTCY</span></tt> instruction. The <tt class="docutils literal"><span class="pre">Z</span></tt> flag is set when the AND of both bytes with the test word is zero but the <tt class="docutils literal"><span class="pre">C</span></tt> flag does not represent the XOR of all 16 bits.</p>
<p>A full suite of 16-bit shifts and rotates are also available. They work the same as their 8-bit equivalents.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>sl0_16</td>
<td>sl1_16</td>
<td>sla_16</td>
<td>slx_16</td>
</tr>
<tr class="row-even"><td>sr0_16</td>
<td>sr1_16</td>
<td>sra_16</td>
<td>srx_16</td>
</tr>
<tr class="row-odd"><td>rl16</td>
<td>rr16</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">sl0_16(</span><span class="s">rx</span><span class="p">,</span> <span class="m">4</span><span class="nb">)</span> <span class="c">; Multiply by 2**4</span>
</pre></div>
</div>
</div>
<div class="section" id="bit-io">
<span id="bit-i-o-operations"></span><h2>16-bit IO<a class="headerlink" href="#bit-io" title="Permalink to this headline">Â¶</a></h2>
<p>16-bit versions of the port and scratchpad I/O operations are available. You can use the <tt class="docutils literal"><span class="pre">mem16()</span></tt> macro to define pairs of memory and port addresses for simplification. The variants using a pointer register increment by two so that successive calls can be made to work on contiguous ranges of addresses.</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="24%" />
<col width="24%" />
<col width="28%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>fetch16</td>
<td>store16</td>
<td>input16</td>
<td>output16</td>
</tr>
</tbody>
</table>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">mem16(</span><span class="s">M_ACCUM</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="nb">)</span>
<span class="nb">reg16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s4</span><span class="p">,</span> <span class="s">s3</span><span class="nb">)</span>

<span class="nb">fetch16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">M_ACCUM</span><span class="nb">)</span>  <span class="c">; Fetch direct from address</span>

<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="n">M_ACCUM_L</span>    <span class="c">; Low byte constant defined by mem16()</span>
<span class="nb">fetch16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s0</span><span class="nb">)</span>       <span class="c">; Fetch from indirect pointer</span>
<span class="nb">fetch16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s0</span><span class="nb">)</span>       <span class="c">; Fetch next word</span>
</pre></div>
</div>
<p>Similarly for port I/O.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">mem16(</span><span class="s">P_ACCUM</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1a</span><span class="nb">)</span>

<span class="nb">input16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">P_ACCUM</span><span class="nb">)</span>  <span class="c">; Input direct from address</span>

<span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="n">P_ACCUM_L</span>
<span class="nb">input16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s0</span><span class="nb">)</span>       <span class="c">; Input from indirect pointer</span>
<span class="nb">input16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s0</span><span class="nb">)</span>       <span class="c">; Input next word</span>
</pre></div>
</div>
</div>
<div class="section" id="multiply-and-divide">
<span id="multiply-and-divide-routines"></span><h2>Multiply and divide<a class="headerlink" href="#multiply-and-divide" title="Permalink to this headline">Â¶</a></h2>
<p>The general purpose PicoBlaze 8x8 multiply and divide routines are made available with arbitrary register allocations to suit your needs. A set of constant multiply and divide routines can also be generated for faster results than the general purpose functions. The following macros are available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>multiply8x8</td>
<td>8x8-bit unsigned</td>
</tr>
<tr class="row-even"><td>multiply8x8s</td>
<td>8x8-bit signed</td>
</tr>
<tr class="row-odd"><td>multiply8x8su</td>
<td>8-bit signed x 8-bit unsigned</td>
</tr>
<tr class="row-even"><td>divide8x8</td>
<td>8/8-bit unsigned</td>
</tr>
<tr class="row-odd"><td>divide8x8s</td>
<td>8/8-bit signed</td>
</tr>
<tr class="row-even"><td>divide16x8</td>
<td>16/8-bit unsigned</td>
</tr>
<tr class="row-odd"><td>divide16x8s</td>
<td>16/8-bit signed</td>
</tr>
<tr class="row-even"><td>multiply8xk</td>
<td>8-bit x constant</td>
</tr>
<tr class="row-odd"><td>multiply8xk_small</td>
<td>8-bit x constant (result less than 256)</td>
</tr>
<tr class="row-even"><td>divide8xk</td>
<td>8-bit / constant</td>
</tr>
</tbody>
</table>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nl">init:</span>
  ...
  <span class="k">jump</span> <span class="n">main</span> <span class="c">; Skip over our functions</span>

  <span class="c">; Configure multiply and divide functions (sE is a temp register)</span>
  <span class="nb">reg16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s5</span><span class="p">,</span> <span class="s">s4</span><span class="nb">)</span>
  <span class="nb">multiply8x8(</span><span class="s">mul8</span><span class="p">,</span> <span class="s">s0</span><span class="p">,</span> <span class="s">s1</span><span class="p">,</span> <span class="s">rx</span><span class="nb">)</span>     <span class="c">; rx = s0 * s1</span>

  <span class="nb">divide8x8(</span><span class="s">div8</span><span class="p">,</span> <span class="s">s0</span><span class="p">,</span> <span class="s">s1</span><span class="p">,</span> <span class="s">s6</span><span class="p">,</span> <span class="s">s7</span><span class="nb">)</span>   <span class="c">; s6 = s0 / s1  rem. s7</span>

  <span class="nb">multiply8xk(</span><span class="s">mul8k7</span><span class="p">,</span> <span class="s">s0</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="s">rx</span><span class="nb">)</span>        <span class="c">; rx = s0 * 7 (Multiplier can be greater than 255)</span>

  <span class="nb">multiply8xk_small(</span><span class="s">mul8k7s</span><span class="p">,</span> <span class="s">s0</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="s">s1</span><span class="nb">)</span> <span class="c">; s1 = s0 * 7 (Result must fit in one byte)</span>

  <span class="nb">divide8xk(</span><span class="s">div8k</span><span class="p">,</span> <span class="s">s0</span><span class="p">,</span> <span class="m">7</span><span class="p">,</span> <span class="s">s1</span><span class="nb">)</span>       <span class="c">; s1 = s0 / 7 (No remainder)</span>

<span class="nl">main:</span>

  <span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="m">20&#39;d</span>
  <span class="k">load</span> <span class="n">s1</span><span class="p">,</span> <span class="m">3&#39;d</span>
  <span class="k">call</span> <span class="n">mul8</span>    <span class="c">; rx = 20 * 3</span>

  <span class="k">call</span> <span class="n">div8</span>    <span class="c">; s6 = 20 / 3</span>

  <span class="k">call</span> <span class="n">mul8k7</span>  <span class="c">; rx = 20 * 7</span>

  <span class="k">call</span> <span class="n">mul8k7s</span> <span class="c">; s1 = 20 * 7</span>

  <span class="k">call</span> <span class="n">div8k</span>   <span class="c">; s1 = 20 / 7</span>
</pre></div>
</div>
</div>
<div class="section" id="expressions">
<h2>Expressions<a class="headerlink" href="#expressions" title="Permalink to this headline">Â¶</a></h2>
<p>A family of expression evaluator macros are provided that can implement arithmetic and other operations using pseudo-infix notation. The basic principle is borrowed from the PL360 high level assembler. You can write an assignment expression of the form <tt class="docutils literal"><span class="pre">expr(&lt;target</span> <span class="pre">register&gt;</span> <span class="pre">:=</span> <span class="pre">&lt;val&gt;</span> <span class="pre">op</span> <span class="pre">&lt;val&gt;</span> <span class="pre">[op</span> <span class="pre">&lt;val&gt;]*)</span></tt>. Spaces are required between all symbols.</p>
<p><tt class="docutils literal"><span class="pre">val</span></tt> is one of:</p>
<table border="1" class="docutils">
<colgroup>
<col width="100%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>register</td>
</tr>
<tr class="row-even"><td>literal expression (with no internal spaces)</td>
</tr>
<tr class="row-odd"><td>&#8220;<cite>sp[&lt;addr&gt;]</cite>&#8221; reverse assignment to scratchpad address</td>
</tr>
<tr class="row-even"><td>&#8220;<cite>spi[&lt;reg&gt;]</cite>&#8221; reverse assignment to indirect scratchpad address in register</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal"><span class="pre">op</span></tt> is one of:</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="77%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>+, -, <cite>*</cite>, /</td>
<td>arithmetic: add, subtract, multiply, divide</td>
</tr>
<tr class="row-even"><td>&amp;, <cite>|</cite>, ^</td>
<td>bitwise operations: and, or, xor</td>
</tr>
<tr class="row-odd"><td>&lt;&lt;, &gt;&gt;</td>
<td>shifts: left and right</td>
</tr>
<tr class="row-even"><td>=:</td>
<td>reverse assignment</td>
</tr>
</tbody>
</table>
<p>Operations are evaluated from left to right with <em>no precedence</em>. The target register is used as the left operand of all operations. It is updated with the result after each operation.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">expr(</span><span class="s">s0</span> <span class="o">:=</span> <span class="s">s1</span> <span class="o">+</span> <span class="s">s2</span> <span class="o">=:</span> <span class="s">s3</span> <span class="o">&gt;&gt;</span> <span class="m">2</span><span class="nb">)</span>
</pre></div>
</div>
<p>Arithmetic is performed on <tt class="docutils literal"><span class="pre">s0</span></tt> at each stage. The reverse assignment to <cite>s3`</cite> captures the intermediate result of <tt class="docutils literal"><span class="pre">s1</span> <span class="pre">+</span> <span class="pre">s2</span></tt> and then continues with the right shift applied to <tt class="docutils literal"><span class="pre">s0</span></tt>. This expands to:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="c">; Expression: s0 := s1 + s2 =: s3 &gt;&gt; 2</span>
<span class="k">LOAD</span> <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span>
<span class="k">ADD</span> <span class="n">s0</span><span class="p">,</span> <span class="n">s2</span>
<span class="k">LOAD</span> <span class="n">s3</span><span class="p">,</span> <span class="n">s0</span>
<span class="k">SR0</span> <span class="n">s0</span>
<span class="k">SR0</span> <span class="n">s0</span>
</pre></div>
</div>
<p>If you want to use the existing value of a register use it as the first operand after the assignment:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">03</span>
<span class="nb">expr(</span><span class="s">s0</span> <span class="o">:=</span> <span class="s">s0</span> <span class="o">+</span> <span class="m">100</span><span class="nb">)</span>
</pre></div>
</div>
<p>Here are all of the expression macros available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="21%" />
<col width="37%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Macro</th>
<th class="head">Target x Operand</th>
<th class="head">Supported operators</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>expr</td>
<td>8x8</td>
<td>+, -, <cite>*</cite>, /, &amp;, <cite>|</cite>, ^, &lt;&lt;, &gt;&gt;, =:</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>exprs</td>
<td>8x8</td>
<td>+, -, <cite>*</cite>, /, &amp;, <cite>|</cite>, ^, &lt;&lt;, &gt;&gt;, =:</td>
<td>signed <cite>*</cite>, /, and &gt;&gt;</td>
</tr>
<tr class="row-even"><td>expr2</td>
<td>16x8 <cite>*</cite></td>
<td>+, -, <cite>*</cite>, /, &lt;&lt;, &gt;&gt;, =:</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>expr2s</td>
<td>16x8 <cite>*</cite></td>
<td>+, -, <cite>*</cite>, /, &lt;&lt;, &gt;&gt;, =:</td>
<td>signed for all except &lt;&lt;</td>
</tr>
<tr class="row-even"><td>expr16</td>
<td>16x16</td>
<td>+, -, &amp;, <cite>|</cite>, ^, &lt;&lt;, &gt;&gt;, =:</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>expr16s</td>
<td>16x16</td>
<td>+, -, &amp;, <cite>|</cite>, ^, &lt;&lt;, &gt;&gt;, =:</td>
<td>signed &gt;&gt;</td>
</tr>
</tbody>
</table>
<p><cite>*</cite> <em>The expr2 macros support 16-bit literals as operands of + and -. The first register after the assignment can be 16-bits.</em></p>
<p>16-bit registers must be comma separated register pairs in <tt class="docutils literal"><span class="pre">MSB,LSB</span></tt> order or named 16-bit registers created with <tt class="docutils literal"><span class="pre">reg16()</span></tt>.</p>
<p>For multiplication and division support you must initialize the internal functions with one of the following:</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="60%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Macro</th>
<th class="head">Multiply</th>
<th class="head">Divide</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>expr</td>
<td>use_expr_mul</td>
<td>use_expr_div</td>
</tr>
<tr class="row-odd"><td>exprs</td>
<td>use_expr_muls</td>
<td>use_expr_divs</td>
</tr>
<tr class="row-even"><td>expr2</td>
<td>use_expr_mul</td>
<td>use_expr_div16</td>
</tr>
<tr class="row-odd"><td>expr2s</td>
<td>use_expr_muls and use_expr_mulsu</td>
<td>use_expr_div16s</td>
</tr>
</tbody>
</table>
<p>As an expedient you can invoke &#8220;use_expr_all&#8221; to include all of them and then eliminate any unused mul or div routines with the <tt class="docutils literal"><span class="pre">--remove-dead-code</span></tt> option to Opbasm.</p>
<p>These macros need to be called before any call to <tt class="docutils literal"><span class="pre">expr*()</span></tt> that uses multiplication or division. It is best to place them at the start of the program and jump over them to reach the startup code. The stack must be configured (<tt class="docutils literal"><span class="pre">use_stack(...)</span></tt>) before calling these macros because additional modified registers must be saved and restored.</p>
<p>By default these macros configure the mul and div functions to use the <tt class="docutils literal"><span class="pre">s8,s9</span></tt> or <tt class="docutils literal"><span class="pre">s7,s8,</span> <span class="pre">and</span> <span class="pre">s9</span></tt> registers for input and output. You can modify the register allocation by passing arguments to the <tt class="docutils literal"><span class="pre">use_*</span></tt> macros. The registers <tt class="docutils literal"><span class="pre">sA</span></tt>, <tt class="docutils literal"><span class="pre">sB</span></tt>, and sometimes <tt class="docutils literal"><span class="pre">sC</span></tt> are temporarily altered and restored. The common temp register (default <tt class="docutils literal"><span class="pre">sE</span></tt>) is destructively modified. You can change the tempreg with the <tt class="docutils literal"><span class="pre">use_tempreg()</span></tt> macro. The MSB of multiplication is ignored by subsequent operations. Division by 0 is not detected.</p>
<p>An example of signed expressions applied to converting temperatures:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">use_stack(</span><span class="s">sF</span><span class="p">,</span> <span class="mh">0x3F</span><span class="nb">)</span>
<span class="k">jump</span> <span class="n">start</span>

<span class="k">use_expr_all</span> <span class="c">; Invoke all of the mul and div routines</span>

<span class="c">; Setup register aliases</span>
<span class="nb">reg16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s0</span><span class="p">,</span><span class="s">s1</span><span class="nb">)</span>
<span class="nb">reg16(</span><span class="s">ry</span><span class="p">,</span> <span class="s">s2</span><span class="p">,</span><span class="s">s3</span><span class="nb">)</span>
<span class="nb">vars(</span><span class="s">s4</span> <span class="s">is</span> <span class="s">celsius</span><span class="p">,</span> <span class="s">s5</span> <span class="s">is</span> <span class="s">fahrenheit</span><span class="nb">)</span>

<span class="c">; Convert temperature</span>
<span class="nl">c_to_f:</span>
  <span class="k">load</span> <span class="nb">reglower(</span><span class="s">rx</span><span class="nb">)</span><span class="p">,</span> <span class="n">celsius</span>     <span class="c">; Load 8-bit Celsius temperature</span>
  <span class="nb">signex(</span><span class="s">rx</span><span class="nb">)</span>                     <span class="c">; Sign extend to 16-bits</span>
  <span class="nb">expr2s(</span><span class="s">rx</span> <span class="o">:=</span> <span class="s">rx</span> <span class="o">*</span> <span class="m">9</span> <span class="o">/</span> <span class="m">5</span> <span class="o">+</span> <span class="m">32</span><span class="nb">)</span>  <span class="c">; Perform 16x8-bit signed arithmetic to get Fahrenheit</span>
  <span class="k">return</span>

<span class="nl">c_to_f_fast:</span> <span class="c">; Saves approx. 130 instructions compared to c_to_f with multiply</span>
  <span class="k">load</span> <span class="nb">reglower(</span><span class="s">ry</span><span class="nb">)</span><span class="p">,</span> <span class="n">celsius</span>     <span class="c">; Load 8-bit Celsius temperature</span>
  <span class="nb">signex(</span><span class="s">ry</span><span class="nb">)</span>                     <span class="c">; Sign extend to 16-bits</span>
  <span class="nb">expr16s(</span><span class="s">rx</span> <span class="o">:=</span> <span class="s">ry</span> <span class="o">&lt;&lt;</span> <span class="m">3</span> <span class="o">+</span> <span class="s">ry</span><span class="nb">)</span>    <span class="c">; Multiply by 9 with shift and add</span>
  <span class="nb">expr2s(</span><span class="s">rx</span> <span class="o">:=</span> <span class="s">rx</span> <span class="o">/</span> <span class="m">5</span> <span class="o">+</span> <span class="m">32</span><span class="nb">)</span>      <span class="c">; Perform 16x8-bit signed arithmetic to get Fahrenheit</span>
  <span class="k">return</span>

<span class="nl">f_to_c:</span>
  <span class="k">load</span> <span class="nb">reglower(</span><span class="s">rx</span><span class="nb">)</span><span class="p">,</span> <span class="n">fahrenheit</span>  <span class="c">; Load 8-bit Fahrenheit temperature</span>
  <span class="nb">signex(</span><span class="s">rx</span><span class="nb">)</span>                     <span class="c">; Sign extend to 16-bits</span>
  <span class="nb">expr2s(</span><span class="s">rx</span> <span class="o">:=</span> <span class="s">rx</span> <span class="o">-</span> <span class="m">32</span> <span class="o">*</span> <span class="m">5</span> <span class="o">/</span> <span class="m">9</span> <span class="nb">)</span> <span class="c">; Perform 16x8-bit signed arithmetic to get Celsius</span>
  <span class="k">return</span>

<span class="nl">start:</span>
  ...
</pre></div>
</div>
</div>
<div class="section" id="miscellaneous">
<h2>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">Â¶</a></h2>
<p>A few miscellaneous utility macros are included:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="42%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Macro</th>
<th class="head">Description</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>nop</td>
<td>No-operation</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>clearcy</td>
<td>Clear the carry flag</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>setcy</td>
<td>Set the carry flag</td>
<td><tt class="docutils literal"><span class="pre">setcy</span> <span class="pre">or</span> <span class="pre">setcy(&lt;tmpreg&gt;)</span></tt></td>
</tr>
<tr class="row-odd"><td>isnum</td>
<td>Test if a string is a number</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>load_out</td>
<td>Load and output value</td>
<td><tt class="docutils literal"><span class="pre">load_out(s0,</span> <span class="pre">0x01,</span> <span class="pre">P_uart)</span></tt></td>
</tr>
<tr class="row-odd"><td>load_st</td>
<td>Load and store value</td>
<td><tt class="docutils literal"><span class="pre">load_st(s0,</span> <span class="pre">0x01,</span> <span class="pre">M_var)</span></tt></td>
</tr>
<tr class="row-even"><td>reverse</td>
<td>Reverse arguments</td>
<td><tt class="docutils literal"><span class="pre">reverse(1,2,3)</span></tt></td>
</tr>
<tr class="row-odd"><td>swap</td>
<td>Swap registers</td>
<td><tt class="docutils literal"><span class="pre">swap(s0,</span> <span class="pre">s1)</span></tt></td>
</tr>
<tr class="row-even"><td>randlabel</td>
<td>Random label name</td>
<td><tt class="docutils literal"><span class="pre">randlabel(PREFIX_)</span></tt></td>
</tr>
<tr class="row-odd"><td>uniqlabel</td>
<td>Unique label name</td>
<td><tt class="docutils literal"><span class="pre">uniqlabel(PREFIX_)</span></tt></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="manually-running-m4">
<h2>Manually running m4<a class="headerlink" href="#manually-running-m4" title="Permalink to this headline">Â¶</a></h2>
<p>Some users may be unable to use Opbasm due to formal release procedures requiring a &#8220;golden&#8221; assembler. The m4 macro package can still be used with other PicoBlaze assemblers by manually running code through m4:</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; m4 picoblaze.m4 <span class="o">[</span>input <span class="nb">source</span><span class="o">]</span> &gt; expanded_macros.gen.psm
</pre></div>
</div>
<p>The picoblaze.m4 file is located in the opbasm_lib directory of the source distribution.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/opbasm_logo.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">Opbasm</a></h1>



<p class="blurb">Advanced PicoBlaze Assembler</p>



<p>
<iframe src="https://ghbtns.com/github-btn.html?user=kevinpt&repo=opbasm&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>



  <h4>Previous topic</h4>
  <p class="topless"><a href="../index.html"
                        title="previous chapter">Open PicoBlaze Assembler</a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">m4 support in Opbasm</a><ul>
<li><a class="reference internal" href="#installing-m4-on-windows">Installing m4 on Windows</a><ul>
<li><a class="reference internal" href="#mingw">MinGW</a></li>
<li><a class="reference internal" href="#gnuwin32">GnuWin32</a></li>
<li><a class="reference internal" href="#cygwin">Cygwin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overview-of-m4">Overview of m4</a></li>
<li><a class="reference internal" href="#type-conversions">Type conversions</a></li>
<li><a class="reference internal" href="#general-purpose-macros">General purpose macros</a></li>
<li><a class="reference internal" href="#stack-operations">Stack operations</a></li>
<li><a class="reference internal" href="#bitfield-operations">Bitfield operations</a></li>
<li><a class="reference internal" href="#shift-and-rotate">Shift and rotate</a></li>
<li><a class="reference internal" href="#conditional-jump-call-and-return">Conditional jump call and return</a></li>
<li><a class="reference internal" href="#conditional-if-then-else">Conditional if-then-else</a><ul>
<li><a class="reference internal" href="#c-style-syntax">C-style syntax</a></li>
</ul>
</li>
<li><a class="reference internal" href="#looping">Looping</a><ul>
<li><a class="reference internal" href="#id2">C-style syntax</a></li>
</ul>
</li>
<li><a class="reference internal" href="#delay-generators">Delay generators</a></li>
<li><a class="reference internal" href="#string-and-table-operations">String and table operations</a><ul>
<li><a class="reference internal" href="#escaped-strings">Escaped strings</a></li>
<li><a class="reference internal" href="#portable-strings">Portable strings</a></li>
<li><a class="reference internal" href="#packed-strings">Packed strings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bit-arithmetic">8-bit arithmetic</a></li>
<li><a class="reference internal" href="#bit-arithmetic-logical-and-shift-operators">16-bit arithmetic</a></li>
<li><a class="reference internal" href="#bit-io">16-bit IO</a></li>
<li><a class="reference internal" href="#multiply-and-divide">Multiply and divide</a></li>
<li><a class="reference internal" href="#expressions">Expressions</a></li>
<li><a class="reference internal" href="#miscellaneous">Miscellaneous</a></li>
<li><a class="reference internal" href="#manually-running-m4">Manually running m4</a></li>
</ul>
</li>
</ul>
<h3>Other projects</h3>

<div id="proj_list">
<p>

<a href="http://kevinpt.github.io/ripyl/">Ripyl</a><br>
<a href="http://code.google.com/p/vertcl">Vertcl</a><br>
<a href="http://code.google.com/p/vhdl-extras">Vhdl-extras</a><br>
<a href="http://kevinpt.github.io/lecroy-colorizer/">Lecroy-colorizer</a>
</p>
</div>

<script>
$(function() { // Retrieve list of repositories from Github and dynamically insert them into sidebar

if(!window.sessionStorage || !JSON) { return; } // Punt on crusty browsers (looking at you IE10)

function JSONP( url, callback ) {
	var id = ( 'jsonp' + Math.random() * new Date() ).replace('.', '');
	var script = document.createElement('script');
	script.src = url.replace( 'callback=?', 'callback=' + id );
	document.body.appendChild( script );
	window[ id ] = function( data ) {
		if (callback) {
			callback( data );
		}
	};
}

// Build dictionary indexing lower cased project names with their preferred format
var knownProjects = ["VHDL-extras", "Ripyl", "VerTcl", "LeCroy-colorizer", "Opbasm"];
var projectDict = {};
$.each(knownProjects, function(index, v) {
  projectDict[v.toLowerCase()] = v;
});

function insert_projects(projects) {
    var links = [];
    var cur_proj = "Opbasm".toLowerCase();
    
    $.each(projects, function(key, value) {
      if(key != cur_proj) {
        var title;
        if(key in projectDict) {
          title = projectDict[key];
        } else { // Capitalize first char
          title = key.replace(/^./, function(match) {return match.toUpperCase()});
        }
        links.push("<a href='"+ value +"'>" + title + "</a>");
      }
    });
    
    $("#proj_list").html("<p>"+ links.join("<br>") +"</p>");
}

var now = new Date().getTime();
if(sessionStorage.KTcacheTime && now - sessionStorage.KTcacheTime < 5*60*1000 ) { // Use cached values (5 min. expiry)
  insert_projects(JSON.parse(sessionStorage.KTprojects));
} else { // Retrieve current projects
  JSONP("https://api.github.com/users/kevinpt/repos?type=owner&callback=?", function(response) {
    var projects = {};
    $.each(response.data, function(index, value) {
      projects[value.name] = value.homepage;
    });
    
    insert_projects(projects);
    
    // Store data in session cache
    sessionStorage.KTprojects = JSON.stringify(projects);
    var now = new Date().getTime();
    sessionStorage.KTcacheTime = now;
  });  
}

});
</script>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
      &copy;2015, Kevin Thibedeau.
      
      |
      <a href="../_sources/rst/m4.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52148206-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>