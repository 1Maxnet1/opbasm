<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Open PicoBlaze Assembler &mdash; Opbasm 1.3 documentation</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/project.css" type="text/css" />
    <link rel="stylesheet" href="_static/tty/tty-player.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Opbasm 1.3 documentation" href="#" />
    <link rel="next" title="m4 support in Opbasm" href="rst/m4.html" />

   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

<script src="https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/0.7.5/webcomponents-lite.min.js"></script>
<script src="_static/tty/term.min.js"></script>
<script src="_static/tty/tty-player.min.js"></script>

<style>
	.terminal-cursor {
		color: #000;
		background: green;
	}
	.terminal, .title {
		font-size:x-small;
	}
</style>


  </head>
  <body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="open-picoblaze-assembler">
<h1>Open PicoBlaze Assembler<a class="headerlink" href="#open-picoblaze-assembler" title="Permalink to this headline">¶</a></h1>
<p>Opbasm is a free cross-platform assembler for the PicoBlaze-3 (PB3) and PicoBlaze-6 (PB6) microcontrollers <a class="reference external" href="http://www.xilinx.com/products/intellectual-property/picoblaze.html">provided by Xilinx</a>. It will run readily on any platform with a Python interpreter. Opbasm provides a better performing solution to assembling PicoBlaze code without resorting to DOS or Windows emulation to run the native KCPSM assemblers.</p>
<tty-player autoplay loop controls src="_static/tty/demo.ttyrec"></tty-player><p><strong>Special features of Opbasm:</strong></p>
<blockquote>
<div><ul class="simple">
<li>Optional <a class="reference internal" href="rst/m4.html"><em>m4 preprocessor macros</em></a> are available when the m4 program is installed. An extensive set of built-in macros provide more advanced features than the base language. For example, converting temperature scales becomes as easy as this:</li>
</ul>
<blockquote>
<div><div class="highlight-picoblaze"><div class="highlight"><pre><span class="nb">reg16(</span><span class="s">rx</span><span class="p">,</span> <span class="s">s4</span><span class="p">,</span><span class="s">s5</span><span class="nb">)</span>                <span class="c">; Create a virtual 16-bit register pair named rx</span>

<span class="nl">c_to_f:</span>
  <span class="k">load</span> <span class="nb">reglower(</span><span class="s">rx</span><span class="nb">)</span><span class="p">,</span> <span class="n">s0</span>         <span class="c">; Load 8-bit Celsius temperature into low byte</span>
  <span class="nb">signex(</span><span class="s">rx</span><span class="nb">)</span>                    <span class="c">; Sign extend to 16-bits</span>
  <span class="nb">expr2s(</span><span class="s">rx</span> <span class="o">:=</span> <span class="s">rx</span> <span class="o">*</span> <span class="m">9</span> <span class="o">/</span> <span class="m">5</span> <span class="o">+</span> <span class="m">32</span><span class="nb">)</span> <span class="c">; Perform 16x8-bit signed arithmetic to get Fahrenheit</span>
  <span class="k">return</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Includes an optimizer that performs <a class="reference internal" href="#static-code-analysis">static code analysis</a> to identify dead code and optionally remove it. This permits the development of code libraries that can be included without wasting memory on unused functions.</li>
<li>Code block annotations with <a class="reference internal" href="#user-defined-pragma-meta-comments">user defined PRAGMA meta-comments</a>.</li>
<li>A basic <a class="reference internal" href="rst/opbsim.html"><em>command line simulator Opbsim</em></a> is included.</li>
</ul>
</div></blockquote>
<p>Support for the full PicoBlaze-6 syntax is provided as well as <a class="reference internal" href="#enabling-most-of-the-new-pb6-syntax-enhancements-in-picoblaze-3-code">enabling most of the new PB6 syntax enhancements in PicoBlaze-3 code</a>. The original templating system for ROM components is supported as well as a more flexible <a class="reference internal" href="#generic-rom-component">generic ROM component</a> that can read <em>.mem</em> and <em>.hex</em> files directly during synthesis and simulation. A utility script is included that permits <a class="reference internal" href="#updating-the-rom-contents-of-a-bitstream-file">updating the ROM contents of a bitstream file</a> without requiring resynthesis as was formerly supplied by the DOS-based KCPSM3 tools.</p>
<p>Files generated on non-Windows platforms will not have DOS line endings and PicoBlaze-3 files are not restricted to 8.3 file names. Opbasm also runs significantly faster than the native implementation:</p>
<img alt="_images/opbasm_perf.png" src="_images/opbasm_perf.png" />
<div class="section" id="learning-about-picoblaze">
<h2>Learning about PicoBlaze<a class="headerlink" href="#learning-about-picoblaze" title="Permalink to this headline">¶</a></h2>
<p>If you are unfamiliar with the PicoBlaze architecture you can review the <a class="reference internal" href="rst/language.html"><em>reference guide</em></a> that describes its inner workings. The official documentation for KCPSM6 is also useful as Opbasm supports its syntax completely with a few extensions. If you are unfamiliar with assembly language programming in general there is a <a class="reference internal" href="rst/tutorial.html"><em>tutorial</em></a> that can guide you through the process of writing in assembly and demonstrates the steps needed to develop a working program.</p>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>Opbasm requires either Python 2.7 or Python 3.x and no additional libraries. The installation script depends on setuptools which will be installed if it isn&#8217;t currently present in your Python distribution. Optional macro support is provided when m4 is installed. You can get optional colorized output from the scripts by installing the Python colorama package. The source is written in Python 2.7 syntax but will convert cleanly to Python 3 when the installer passes it through <tt class="docutils literal"><span class="pre">2to3</span></tt>.</p>
</div>
<div class="section" id="download">
<h2>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h2>
<p>You can access the Opbasm Git repository from <a class="reference external" href="https://github.com/kevinpt/opbasm">Github</a>. <a class="reference external" href="https://goo.gl/tz2vwz">Packaged source code</a> is also available for download. You can install direct from PyPI with the <tt class="docutils literal"><span class="pre">pip</span></tt> command if you have it available.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>You must have Python installed first. Most modern Linux distributions and OS/X have it available by default. There are a number of options available for Windows. If you don&#8217;t already have a favorite, I recommend getting one of the <a class="reference external" href="http://www.scipy.org/install.html">&#8220;full-stack&#8221; Python distros</a> that are geared toward scientific computing such as Anaconda or Python(x,y).</p>
<p>If your OS has a package manager, it may be preferable to install Python setuptools through that tool before attempting to install Opbasm. Otherwise, the installation script will install these packages directly without registering them with the OS package manager.</p>
<p>The easiest way to install Opbasm is from <a class="reference external" href="https://pypi.python.org/pypi/opbasm">PyPI</a>.</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; pip install --upgrade opbasm
</pre></div>
</div>
<p>This will download and install the latest release, upgrading if you already have it installed. If you don&#8217;t have <tt class="docutils literal"><span class="pre">pip</span></tt> you may have the <tt class="docutils literal"><span class="pre">easy_install</span></tt> command available which can be used to install <tt class="docutils literal"><span class="pre">pip</span></tt> on your system:</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; easy_install pip
</pre></div>
</div>
<p>You can also use <tt class="docutils literal"><span class="pre">pip</span></tt> to get the latest development code from Github:</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; pip install --upgrade https://github.com/kevinpt/opbasm/tarball/master
</pre></div>
</div>
<p>If you manually downloaded a source package or created a clone with Git you can install Opbasm with the following command run from the base Opbasm directory:</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; python setup.py install
</pre></div>
</div>
<p>On Linux systems you may need to install with root privileges using the <em>sudo</em> command.</p>
<p>After a successful install the Opbasm scripts will be available. On Linux they should be immediately accessible from your current search path. On Windows you will need to make sure that the <tt class="docutils literal"><span class="pre">&lt;Python</span> <span class="pre">root&gt;\Scripts</span></tt> directory is in your %PATH% environment variable.</p>
<p>If you can&#8217;t use the installer script, it is possible to run <em>opbasm.py</em> directly without installation.</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; python opbasm.py ...
</pre></div>
</div>
<p>The m4 preprocessor is optional. It is usually already installed on Linux. The m4 documentation provides <a class="reference internal" href="rst/m4.html#guidance-on-installing-m4-under-windows"><em>guidance on installing m4 under Windows</em></a>.</p>
</div>
<div class="section" id="picoblaze-3-enhancements">
<span id="enabling-most-of-the-new-pb6-syntax-enhancements-in-picoblaze-3-code"></span><h2>PicoBlaze-3 enhancements<a class="headerlink" href="#picoblaze-3-enhancements" title="Permalink to this headline">¶</a></h2>
<p>You can use all PicoBlaze-6 syntax extensions in PicoBlaze-3 code that don&#8217;t depend on PB6 specific instructions. This makes writing PB3 code much less painful.</p>
<p>For PicoBlaze-3 you can use the following syntax extensions from PicoBlaze-6:</p>
<blockquote>
<div><ul class="simple">
<li>Decimal, binary, and character literals (<tt class="docutils literal"><span class="pre">41'd,</span> <span class="pre">01000001'b,</span> <span class="pre">&quot;A&quot;</span></tt>)</li>
<li>Predefined char constants and date/time stamp fields (<tt class="docutils literal"><span class="pre">CR,</span> <span class="pre">LF,</span> <span class="pre">HT,</span> <span class="pre">datestamp_day</span></tt>, etc.)</li>
<li>Inverted constants ( <tt class="docutils literal"><span class="pre">~my_const</span></tt> )</li>
<li>Environment variable constants ( <tt class="docutils literal"><span class="pre">constant</span> <span class="pre">foo,</span> <span class="pre">%my_env_const</span></tt> )</li>
<li><a class="reference internal" href="rst/language.html#inst-include"><em>INCLUDE</em></a>, <a class="reference internal" href="rst/language.html#inst-default-jump"><em>DEFAULT_JUMP</em></a>, and <a class="reference internal" href="rst/language.html#inst-inst"><em>INST</em></a> directives</li>
<li>Address label constants ( <tt class="docutils literal"><span class="pre">my_label'upper</span>&nbsp; <span class="pre">my_label'lower</span></tt> )</li>
</ul>
</div></blockquote>
<p>For PicoBlaze-3 you <em>CANNOT</em> use the following:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="rst/language.html#inst-string"><em>STRING</em></a> and <a class="reference internal" href="rst/language.html#inst-table"><em>TABLE</em></a> directives</li>
<li><a class="reference internal" href="rst/language.html#inst-pb6"><em>PicoBlaze-6 instructions</em></a> (<tt class="docutils literal"><span class="pre">CALL&#64;,</span> <span class="pre">COMPARECY,</span> <span class="pre">HWBUILD,</span> <span class="pre">JUMP&#64;,</span> <span class="pre">LOAD&amp;RETURN,</span> <span class="pre">OUTPUTK,</span> <span class="pre">REGBANK,</span> <span class="pre">STAR,</span> <span class="pre">TESTCY</span></tt>)</li>
</ul>
</div></blockquote>
<p>Note that the included m4 macros have <a class="reference internal" href="rst/m4.html#string-and-table-ops"><em>alternative string operations</em></a> that do work on PicoBlaze-3 as well as a <a class="reference internal" href="rst/m4.html#portable-string-and-table-operations"><em>portable string system</em></a> that is optimized for both target processors.</p>
<p>Refer to the file &#8220;all_kcpsm6_syntax.psm&#8221; distributed with KCPSM6 for a detailed
explanation of the new PicoBlaze-6 syntax.</p>
</div>
<div class="section" id="picoblaze-6-enhancements">
<h2>PicoBlaze-6 enhancements<a class="headerlink" href="#picoblaze-6-enhancements" title="Permalink to this headline">¶</a></h2>
<p>The native PB6 assembler KCPSM6.exe has a -c switch to limit the size of memory. Opbasm provides -m to do the same as well as -s to limit the scratchpad memory size to 64 or 128 bytes. MEM format files are output by default. KCPSM6-style HEX format is activated with <em>-x</em>.</p>
</div>
<div class="section" id="syntax-extensions">
<h2>Syntax extensions<a class="headerlink" href="#syntax-extensions" title="Permalink to this headline">¶</a></h2>
<p>Two non-standard syntax extensions have been implemented in Opbasm. The first is the ability to define local labels by prefixing them with a &#8221;.&#8221;. Local labels do not have to be globally unique, making it easier to construct commonly used names inside procedures without concern for collisions or excessively long names. Internally, local labels are implemented by appending them to the immediately preceeding global label. The fully expanded name can be referred to anywhere in the program. The bare local label can be referred anywhere between the nearest global labels bounding it.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nl">my_proc:</span>
  <span class="k">load</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">04</span>
<span class="nl">.loop:</span>            <span class="c">; Local label for this procedure</span>
  <span class="k">add</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s0</span>
  <span class="k">sub</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">01</span>
  <span class="k">compare</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>
  <span class="k">jump</span> <span class="n">nz</span><span class="p">,</span> <span class="n">.loop</span>  <span class="c">; Jump to local loop label</span>
  <span class="k">return</span>

<span class="nl">my_proc2:</span>
  <span class="ge">&lt;something else&gt;</span>
<span class="nl">.loop:</span>            <span class="c">; This is a different loop label</span>
  <span class="ge">&lt;something else&gt;</span>
  <span class="k">return</span>

<span class="k">jump</span> <span class="n">my_proc.loop</span> <span class="c">; Access the local label by referring to its expanded name</span>
</pre></div>
</div>
<p>Another small extension to the syntax is that the <a class="reference internal" href="rst/language.html#inst-address"><em>address</em></a> directive can take a label as a parameter as well as a numeric address. This is most useful when defining an ISR by inserting a <a class="reference internal" href="rst/language.html#inst-jump"><em>jump</em></a> instruction at the vector address and then returning back to a labeled address to resume assembling code from the the next point in memory.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="nl">my_isr:</span>
  <span class="k">address</span> <span class="mh">3FF</span>
  <span class="k">jump</span> <span class="n">my_isr</span>     <span class="c">; Assemble instruction at interrupt vector location</span>
  <span class="k">address</span> <span class="n">my_isr</span>  <span class="c">; Resume assembly at address previously captured in &quot;my_isr&quot;</span>
  <span class="ge">&lt;ISR code&gt;</span>
  <span class="k">returni</span>
</pre></div>
</div>
</div>
<div class="section" id="m4-preprocessor">
<h2>m4 preprocessor<a class="headerlink" href="#m4-preprocessor" title="Permalink to this headline">¶</a></h2>
<p>Opbasm uses the m4 preprocessor to provide enhanced syntax to PicoBlaze developers. A useful package of predefined macros is included automatically when m4 is run. You can activate m4 by naming source files with the &#8221;.psm4&#8221;, or &#8221;.m4&#8221; extensions or by passing the <em>&#8211;m4</em> option. See the more detailed <a class="reference internal" href="rst/m4.html"><em>m4 documentation</em></a> for more information on using the preprocessor macros.</p>
</div>
<div class="section" id="static-code-analysis">
<h2>Static code analysis<a class="headerlink" href="#static-code-analysis" title="Permalink to this headline">¶</a></h2>
<p>Opbasm provides static code analysis to identify unreachable &#8220;dead&#8221; instructions and potentially remove them to eliminate wasted memory. There are three command line options <em>-d</em> (<em>&#8211;report-dead-code</em>), <em>-r</em> (<em>&#8211;remove-dead-code</em>), and <em>-e</em> (<em>&#8211;entry-point</em>) used to control static code analysis.</p>
<p>The <em>-d</em> (<em>&#8211;report-dead-code</em>) option activates static code analysis and shows dead instructions in the log file with &#8220;DEAD&#8221; after the assembled instruction. Instructions identified as dead will be reported and also removed when <em>-r</em> (<em>&#8211;remove-dead-code</em>) is used. Removed instructions appear in the log as comments starting with &#8221;;REMOVED:&#8221;.</p>
<p>Static analysis is performed by following all possible execution paths from a set of initial entry points. There are three possible entry points for PicoBlaze code: address 0, the <a class="reference internal" href="rst/language.html#inst-default-jump"><em>default_jump</em></a> target (if used), and the ISR. The <em>-e</em> (<em>&#8211;entry-point</em>) option provides the address of the ISR entry point. It should be a decimal integer or a hex value in 0xnnn format. The ISR entry point defaults to 0x3FF. You will see a summary of the entry point addresses and the number of dead instructions found reported to standard output.</p>
<p>The static analysis can&#8217;t follow the computed destination of <a class="reference internal" href="rst/language.html#inst-call-at"><em>call&#64;</em></a> and <a class="reference internal" href="rst/language.html#inst-jump-at"><em>jump&#64;</em></a> instructions. A <em>&#8221;;PRAGMA keep&#8221;</em> meta-comment can be used to prevent removal of code they jump to. Surround blocks of code with <em>&#8221;;PRAGMA keep on&#8221;</em> and <em>&#8221;;PRAGMA keep off&#8221;</em> to preserve them. These meta-comments are case insensitive. The log file will show kept instructions with &#8220;KEEP&#8221; after the assembled instruction.</p>
<div class="figure">
<img alt="_images/static_analysis.png" src="_images/static_analysis.png" />
<p class="caption"><em>Static analysis example</em></p>
</div>
<p>As an aid to the user, the static analyzer will automatically keep any code that is called or jumped to from a user annotated &#8220;keep&#8221; block. These blocks are identified with the name &#8220;keep_auto&#8221; in the log file. In addition, &#8220;keep_auto&#8221; is automatically applied to blocks of <a class="reference internal" href="rst/language.html#inst-load-return"><em>load&amp;return</em></a> instructions that are associated with a label in use. The result is that only unreferenced strings and tables will be marked as dead and potentially removed. &#8220;keep_auto&#8221; is also automatically applied to any <a class="reference internal" href="rst/language.html#inst-inst"><em>inst</em></a> directives.</p>
<p>On the first assembly pass it is possible that the amount of extra code present causes spillover beyond the total memory available. When dead code removal is active the bounds checking is suspended on the first pass to allow for the possibility that the code will fit after it is trimmed down. Address bounds checking will still be applied on the final result.</p>
</div>
<div class="section" id="using-opbasm">
<h2>Using Opbasm<a class="headerlink" href="#using-opbasm" title="Permalink to this headline">¶</a></h2>
<p>After installation you are ready to use Opbasm. The native KCPSM assemblers rely on HDL templates to carry assembled ROM data into synthesis. You can continue to use that process by using the provided Spartan-3 template or using a template from the KCPSM6 distribution. You can alternately use the <a class="reference external" href="https://github.com/kevinpt/opbasm/blob/master/templates/picoblaze_rom.vhdl">picoblaze_rom.vhdl</a> component which provides a generic resizeable ROM that reads <em>.mem</em> and <em>.hex</em> files directly without requiring a template. See below for more information on the templating options.</p>
<p>The assembler is invoked with the <em>opbasm</em> script. It supports the following command line syntax:</p>
<div class="highlight-python"><div class="highlight"><pre>Usage: opbasm [-i] &lt;input file&gt; [-n &lt;name&gt;] [-t &lt;template&gt;] [-6|-3] [-m &lt;mem size&gt;] [-s &lt;scratch size&gt;]
              [-d] [-r] [-e &lt;address&gt;]
              [-o &lt;output dir&gt;] [-q] [--m4]
              [--debug-preproc &lt;file&gt;]
       opbasm -g

Options:
  -h, --help            show this help message and exit
  -i INPUT_FILE, --input=INPUT_FILE
                        Input file
  -n MODULE_NAME, --name=MODULE_NAME
                        Module or entity name (defaults to input file name)
  -t TEMPLATE_FILE, --template=TEMPLATE_FILE
                        Template file
  -6, --pb6             Assemble PicoBlaze-6 code
  -3, --pb3             Assemble PicoBlaze-3 code
  -m MEM_SIZE, --mem-size=MEM_SIZE
                        Program memory size
  -s SCRATCH_SIZE, --scratch-size=SCRATCH_SIZE
                        Scratchpad memory size
  -x, --hex             Write HEX in place of MEM file
  --mif                 Write MIF in place of MEM file
  -o OUTPUT_DIR, --outdir=OUTPUT_DIR
                        Output directory
  -d, --report-dead-code
                        Perform dead code analysis shown in log file
  -r, --remove-dead-code
                        Remove dead code from assembled source
  -e ADDRESS, --entry-point=ADDRESS
                        Set address of ISR (or other) entry point
  -c, --color-log       Colorize log file
  -g, --get-templates   Get default template files
  -v, --version         Show OPBASM version
  -q, --quiet           Quiet output
  --m4                  Use m4 preprocessor on all source files
  -D NAME[=VALUE], --define=NAME[=VALUE]
                        Define m4 macro NAME as having VALUE or empty
  --debug-preproc=FILE  Transformed source file after initial preprocessing
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Opbasm currently defaults to using PicoBlaze-3 as the target processor. <strong>Beginning with version 1.4 the default will change to PicoBlaze-6.</strong> You should apply the optional <tt class="docutils literal"><span class="pre">-3</span></tt> switch when writing PB3 build scripts to guard against this future change.</p>
</div>
<p>To compile to PicoBlaze-3 opcodes, use the following:</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; opbasm foo.psm
OPBASM - Open PicoBlaze Assembler
Running in PicoBlaze-3 mode
  Device configuration:
    Memory size: 1024, Scratchpad size: 64

  Reading <span class="nb">source</span>: foo.psm

  Assembling code... SUCCESS
    <span class="m">15</span> instructions out of <span class="m">1024</span> <span class="o">(</span>1%<span class="o">)</span>
    Highest occupied address: 00E hex

  Found template:
    ROM_form.vhdl

  Writing output
        mem map: foo.mem
       log file: foo.log
      VHDL file: foo.vhdl

  Formatted <span class="nb">source</span>:
    foo.fmt
</pre></div>
</div>
<p>To compile to PicoBlaze-6, use the following:</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; opbasm -6 foo.psm
OPBASM - Open PicoBlaze Assembler
Running in PicoBlaze-6 mode
...
</pre></div>
</div>
<p>By default, Opbasm outputs <em>.mem</em> format ROM listings as produced by KCPSM3. If you want to output the <em>.hex</em> format listings produced by KCPSM6 pass the <em>-x</em> option. The only difference is that <em>.mem</em> format includes an &#8220;&#64;nnn&#8221; address directive setting the starting offset for the memory.</p>
<p>Opbasm returns 0 on success and can be used with automated builds using make or another build/scripting system.</p>
<div class="section" id="templating">
<h3>Templating<a class="headerlink" href="#templating" title="Permalink to this headline">¶</a></h3>
<p>All of the official KCPSM-provided HDL templates are supported. Any custom templates you have created can be used unchanged. Because of improvements to XST&#8217;s support for synthesis of BRAM generics since the last release of KCPSM3, an updated Spartan-3 template <a class="reference external" href="https://github.com/kevinpt/opbasm/blob/master/templates/ROM_form_S3_1K.vhdl">ROM_form_S3_1K.vhdl</a> is included that eliminates the warnings from redundant attribute declarations. Templates for PicoBlaze-6 devices can be found in the KCPSM6 distribution.</p>
<p>Because Opbasm is more flexible in the naming of modules, the original template system&#8217;s assumption that the &#8220;{name}&#8221; field matches the input source file isn&#8217;t necessarily valid. A new field &#8220;{source file}&#8221; is added that clearly indicates the original top level source file used to populate a template. This field is optional and only used in a comment so it is not critical to include it in your templates.</p>
<p>The native KCPSM assemblers are hard-coded to look for a template named <em>ROM_form.vhd</em> or <em>ROM_form.v</em>. Opbasm searches for templates by those names (as well as <em>ROM_form.vhdl</em>) but you can also pass the <em>-t &lt;template file&gt;</em> option to specify a different template with any arbitrary name. If your OS supports symbolic links it is recommended to maintain a link from the original template to <em>ROM_form.xxx</em> rather than renaming it to one of the generic defaults.</p>
<p>To save the bother of hunting down templates when you start a new project, you can generate copies of the default templates included with Opbasm using the following command:</p>
<div class="highlight-sh"><div class="highlight"><pre>&gt; opbasm -g
Retrieving default templates...
ROM_form_S3_1K.vhdl,picoblaze_rom.vhdl
  COPYING:  /usr/local/lib/python2.7/dist-packages/opbasm-1.0-py2.7.egg/templates/ROM_form_S3_1K.vhdl
  COPYING:  /usr/local/lib/python2.7/dist-packages/opbasm-1.0-py2.7.egg/templates/picoblaze_rom.vhdl
</pre></div>
</div>
</div>
<div class="section" id="generic-rom-component">
<span id="generic-rom"></span><h3>Generic ROM component<a class="headerlink" href="#generic-rom-component" title="Permalink to this headline">¶</a></h3>
<p>As an alternative to the templating system, a generic, synthesizable VHDL ROM is provided in the <a class="reference external" href="https://github.com/kevinpt/opbasm/blob/master/templates/picoblaze_rom.vhdl">picoblaze_rom.vhdl</a>  file. This component uses XSTs limited support for textio during synthesis to read a <em>.mem</em> or <em>.hex</em> file directly without the use of a template file. It takes advantage of XSTs support for automatically partitioning memories that exceed the maximum size of a BRAM. This provides a simplification of the synthesis flow and you do not need to manually switch to different template files if you change the size of the ROM for PicoBlaze-6 designs. For simulation, this component has the advantage that it doesn&#8217;t have to be recompiled for every change to the PicoBlaze source code in a design and is portable across Xilinx families. It automatically re-reads the latest <em>.mem</em> or <em>.hex</em> whenever the simulation is reset. A generic can be set to select the implementation as BRAM or distributed RAM.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">XST doesn&#8217;t infer the most efficient partition for a 4Kx18 ROM on Spartan-6. The &#8220;<tt class="docutils literal"><span class="pre">ROM_form_S6_4K_&lt;date&gt;.vhd</span></tt>&#8221; template distributed with KCPSM6 uses only 4 BRAMs rather than 5 and may be a better option.</p>
</div>
<p>A dual-ported <tt class="docutils literal"><span class="pre">picoblaze_dp_rom</span></tt> component is also included in this package. It provides a second read/write port that can be connected to internal logic to facilitate use of packed ROM data stored with <tt class="docutils literal"><span class="pre">INST</span></tt> directives or to use a portion of the BRAM as general purpose RAM. The <a class="reference internal" href="rst/m4.html#string-and-table-ops"><em>insttable m4 macros</em></a> are included to simplify the creation of <tt class="docutils literal"><span class="pre">INST</span></tt> directives containing packed byte data.</p>
<p>It is not necessary to have an HDL template file present if you are using the generic ROM.</p>
</div>
</div>
<div class="section" id="user-defined-pragma-meta-comments">
<h2>User defined PRAGMA meta-comments<a class="headerlink" href="#user-defined-pragma-meta-comments" title="Permalink to this headline">¶</a></h2>
<p>To assist with post processing of assembled output, Opbasm includes a facility to annotate blocks of code using PRAGMA meta-comments. It uses a flexible syntax that provides considerable freedom in how you annotate your code.</p>
<div class="highlight-picoblaze"><div class="highlight"><pre>** Start a block:
<span class="cs">;PRAGMA &lt;name&gt; [optional arguments] on|start|begin</span>

** End a block:
<span class="cs">;PRAGMA &lt;name&gt; off|stop|end</span>
</pre></div>
</div>
<p>All fields are case insensitive. Case is preserved for the arguments. Blocks of different types can overlap. PRAGMAs with the &#8220;keep&#8221; name are the only ones with special behavior (see <a class="reference internal" href="#static-code-analysis">static code analysis</a>). All others are just annotations that appear in the log. The optional arguments can be any space separated list of strings. The most likely use case is to annotate functions as follows:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="cs">;PRAGMA FUNCTION empty_func BEGIN</span>
<span class="nl">empty_func:</span> <span class="k">return</span>
<span class="cs">;PRAGMA function END</span>

<span class="cs">;PRAGMA keep on</span>
<span class="cs">;PRAGMA function another_func arg2 arg3 start</span>
<span class="nl">another_func:</span>
            <span class="k">output</span> <span class="n">s0</span><span class="p">,</span> <span class="mh">00</span>
            <span class="k">return</span>
<span class="cs">;PRAGMA function stop</span>
<span class="cs">;PRAGMA keep off</span>

<span class="cs">;PRAGMA function nothing begin</span>
<span class="nl">nothing:</span>
<span class="cs">;PRAGMA function end</span>
</pre></div>
</div>
<p>The blocks are listed in a section of the log file like this:</p>
<div class="highlight-python"><div class="highlight"><pre>List of pragma blocks
---------------------
   Name      Addr range   Value
   ----      ----------   -----
   function  (025 - 025)  empty_func
   keep      (026 - 027)  True
   function  (026 - 027)  another_func arg2 arg3
</pre></div>
</div>
<p>Blocks containing no instructions are omitted from the log (&#8220;nothing&#8221; in this case). This eliminates any functions removed by static analysis. You can easily extract function bounds from the log file by matching on lines that start with the name you&#8217;ve selected for your PRAGMA.</p>
<p>One potential use for the flexible formatting is to include a signature with a function block. Using VHDL-style syntax you can do the following:</p>
<div class="highlight-picoblaze"><div class="highlight"><pre><span class="cs">;PRAGMA function do_something [s0, s1 return s0] begin</span>
...
</pre></div>
</div>
<p>This function signature will then appear in the log where it can be post-processed by another tool to track register usage for inputs and return values.</p>
</div>
<div class="section" id="updating-bit-files">
<span id="updating-the-rom-contents-of-a-bitstream-file"></span><h2>Updating bit files<a class="headerlink" href="#updating-bit-files" title="Permalink to this headline">¶</a></h2>
<p>The KCPSM3 assembler included a program and batch file that automated the process of updating a PicoBlaze ROM in a bit file without requiring a resynthesis. For PicoBlaze-6 that process has been abandoned in favor of using the JTAG loader.</p>
<p>Because some platforms don&#8217;t readily support the use of the JTAG loader, the old system of updating bit files has been reimplemented as a utility script <tt class="docutils literal"><span class="pre">pb_update</span></tt>. You will need to have a new <em>.mem</em> file along with the top level <em>.ncd</em> and <em>.bit</em> files for the design. The Xilinx ISE tools <tt class="docutils literal"><span class="pre">xdl</span></tt> and <tt class="docutils literal"><span class="pre">data2mem</span></tt> must be accessible from your command line path.</p>
<img alt="_images/pb_update.png" src="_images/pb_update.png" />
<p>When run, the <em>pb_update</em> script will convert the <em>.ncd</em> netlist to the textual <em>.xdl</em> format and scan it for any block RAM instances. If one BRAM is found it is assumed to be the PicoBlaze ROM. If multiple BRAMs are in the design, a list is provided with their instance names and you are prompted to select which one(s) are part of the PicoBlaze ROM.</p>
<p>If the ROM is divided amongst multiple BRAMs the interactive selection process lets you describe the layout of the memory array. You select the BRAM instances needed to fill out a row of memory until 18 bits for an instruction word are allocated. If the required memory depth isn&#8217;t satisfied a new row of memory is started where you continue to add BRAMs. The required depth is derived from the number of words present in the assembled <em>.mem</em> file.</p>
<p>Once the layout is described, <tt class="docutils literal"><span class="pre">pb_update</span></tt> runs the <tt class="docutils literal"><span class="pre">data2mem</span></tt> program with the contents for each BRAM generated according to the layout. After the first run with the interactive BRAM selection, <tt class="docutils literal"><span class="pre">pb_update</span></tt> outputs a string describing the layout specification that can be passed with the <tt class="docutils literal"><span class="pre">-l</span> <span class="pre">&quot;&lt;specification</span> <span class="pre">string&gt;&quot;</span></tt> option to bypass the interactive mode on future runs.</p>
<div class="highlight-python"><div class="highlight"><pre>&gt; pb_update -m foobar.mem -n foobar.ncd
PicoBlaze ROM updater
Running XDL...
Release 14.5 - xdl P.58f (lin64)
Copyright (c) 1995-2012 Xilinx, Inc.  All rights reserved.

Loading device for application Rf_Device from file &#39;6slx4.nph&#39; in environment /usr/local/packages/Xilinx/14.5/ISE_DS/ISE/.
   &quot;foobar&quot; is an NCD, version 3.2, device xc6slx4, package tqg144, speed -3
Successfully converted design &#39;foobar.ncd&#39; to &#39;foobar.xdl&#39;.
Required memory depth: 4096

... &lt;interactive BRAM selection&gt;

Final memory layout:
    Row 0:     0 - 2047    [9][9]
      rom/kcpsm6_rom_lh     2048x9   17 - 9
      rom/kcpsm6_rom_ll     2048x9    8 - 0
    Row 1:  2048 - 4095    [9][9]
      rom/kcpsm6_rom_hh     2048x9   17 - 9
      rom/kcpsm6_rom_hl     2048x9    8 - 0

Layout Spec: &quot;rom/kcpsm6_rom_lh,rom/kcpsm6_rom_ll:rom/kcpsm6_rom_hh,rom/kcpsm6_rom_hl&quot;

Running data2mem...
  data2mem -bm r0_b17_9.bmm -bd r0_b17_9.mem -bt foobar.bit -o b r0_b17_9.bit

Running data2mem...
  data2mem -bm r0_b8_0.bmm -bd r0_b8_0.mem -bt r0_b17_9.bit -o b r0_b8_0.bit

Running data2mem...
  data2mem -bm r1_b17_9.bmm -bd r1_b17_9.mem -bt r0_b8_0.bit -o b r1_b17_9.bit

Running data2mem...
  data2mem -bm r1_b8_0.bmm -bd r1_b8_0.mem -bt r1_b17_9.bit -o b r1_b8_0.bit
Generated updated bit file: new_foobar.bit
</pre></div>
</div>
<p>The updated bit file is created with the prefix &#8220;<tt class="docutils literal"><span class="pre">new_</span></tt>&#8221;.</p>
</div>
<div class="section" id="syntax-highlighting">
<h2>Syntax highlighting<a class="headerlink" href="#syntax-highlighting" title="Permalink to this headline">¶</a></h2>
<p>PicoBlaze syntax highlighting rules for Gedit and Notepad++ have been included in the &#8220;highlight&#8221; directory in the source distribution.</p>
<blockquote>
<div><ul class="simple">
<li>Gedit install: Copy <tt class="docutils literal"><span class="pre">picoblaze.lang</span></tt> to &#8220;~/.local/share/gtksourceview-3.0/language-specs&#8221;. Create the directories if they do not exist.</li>
<li>Notepad++ install: Select &#8220;Language|Define your language...&#8221;. Click &#8220;Import...&#8221; and select the <tt class="docutils literal"><span class="pre">picoblaze.xml</span></tt> file.</li>
</ul>
</div></blockquote>
<div class="toctree-wrapper compound">
</div>
</div>
<div class="section" id="licensing">
<h2>Licensing<a class="headerlink" href="#licensing" title="Permalink to this headline">¶</a></h2>
<p>Opbasm and the included VHDL source is licensed for free commercial and non-commercial use under the terms of the MIT license.</p>
</div>
<div class="section" id="indices-and-tables">
<h2>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><em>Index</em></a></li>
<li><a class="reference internal" href="search.html"><em>Search Page</em></a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="#">
              <img class="logo" src="_static/opbasm_logo.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="#">Opbasm</a></h1>



<p class="blurb">Advanced PicoBlaze Assembler</p>



<p>
<iframe src="https://ghbtns.com/github-btn.html?user=kevinpt&repo=opbasm&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>


<div id="download_links">
  <div class="dl-button">
  <a href="https://goo.gl/tz2vwz"><b>Download</b></a><br>
  </div>

  <div class="js-clone-url clone-url open" data-protocol-type="http">
    <span>Git clone URL:</span>
    <div>
      <input type="text" value="https://github.com/kevinpt/opbasm.git"
             onclick="this.focus();this.select()" readonly="readonly" aria-label="Git clone URL">
    </div>
  </div>
  <br>
</div><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="#">Documentation overview</a><ul>
      <li>Next: <a href="rst/m4.html" title="next chapter">m4 support in Opbasm</a></li>
  </ul></li>
</ul>
</div>
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Open PicoBlaze Assembler</a><ul>
<li><a class="reference internal" href="#learning-about-picoblaze">Learning about PicoBlaze</a></li>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#download">Download</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#picoblaze-3-enhancements">PicoBlaze-3 enhancements</a></li>
<li><a class="reference internal" href="#picoblaze-6-enhancements">PicoBlaze-6 enhancements</a></li>
<li><a class="reference internal" href="#syntax-extensions">Syntax extensions</a></li>
<li><a class="reference internal" href="#m4-preprocessor">m4 preprocessor</a></li>
<li><a class="reference internal" href="#static-code-analysis">Static code analysis</a></li>
<li><a class="reference internal" href="#using-opbasm">Using Opbasm</a><ul>
<li><a class="reference internal" href="#templating">Templating</a></li>
<li><a class="reference internal" href="#generic-rom-component">Generic ROM component</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-defined-pragma-meta-comments">User defined PRAGMA meta-comments</a></li>
<li><a class="reference internal" href="#updating-bit-files">Updating bit files</a></li>
<li><a class="reference internal" href="#syntax-highlighting">Syntax highlighting</a></li>
<li><a class="reference internal" href="#licensing">Licensing</a></li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
</ul>
<h3>Other projects</h3>

<div id="proj_list">
<p>

<a href="http://kevinpt.github.io/ripyl/">Ripyl</a><br>
<a href="http://code.google.com/p/vertcl">Vertcl</a><br>
<a href="http://code.google.com/p/vhdl-extras">Vhdl-extras</a><br>
<a href="http://kevinpt.github.io/lecroy-colorizer/">Lecroy-colorizer</a>
</p>
</div>

<script>
$(function() { // Retrieve list of repositories from Github and dynamically insert them into sidebar

if(!window.sessionStorage || !JSON) { return; } // Punt on crusty browsers (looking at you IE10)

function JSONP( url, callback ) {
	var id = ( 'jsonp' + Math.random() * new Date() ).replace('.', '');
	var script = document.createElement('script');
	script.src = url.replace( 'callback=?', 'callback=' + id );
	document.body.appendChild( script );
	window[ id ] = function( data ) {
		if (callback) {
			callback( data );
		}
	};
}

// Build dictionary indexing lower cased project names with their preferred format
var knownProjects = ["VHDL-extras", "Ripyl", "VerTcl", "LeCroy-colorizer", "Opbasm"];
var projectDict = {};
$.each(knownProjects, function(index, v) {
  projectDict[v.toLowerCase()] = v;
});

function insert_projects(projects) {
    var links = [];
    var cur_proj = "Opbasm".toLowerCase();
    
    $.each(projects, function(key, value) {
      if(key != cur_proj) {
        var title;
        if(key in projectDict) {
          title = projectDict[key];
        } else { // Capitalize first char
          title = key.replace(/^./, function(match) {return match.toUpperCase()});
        }
        links.push("<a href='"+ value +"'>" + title + "</a>");
      }
    });
    
    $("#proj_list").html("<p>"+ links.join("<br>") +"</p>");
}

var now = new Date().getTime();
if(sessionStorage.KTcacheTime && now - sessionStorage.KTcacheTime < 5*60*1000 ) { // Use cached values (5 min. expiry)
  insert_projects(JSON.parse(sessionStorage.KTprojects));
} else { // Retrieve current projects
  JSONP("https://api.github.com/users/kevinpt/repos?type=owner&callback=?", function(response) {
    var projects = {};
    $.each(response.data, function(index, value) {
      if(!value.fork)
        projects[value.name] = value.homepage;
    });
    
    insert_projects(projects);
    
    // Store data in session cache
    sessionStorage.KTprojects = JSON.stringify(projects);
    var now = new Date().getTime();
    sessionStorage.KTcacheTime = now;
  });  
}

});
</script>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Kevin Thibedeau.
      
      |
      <a href="_sources/index.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>